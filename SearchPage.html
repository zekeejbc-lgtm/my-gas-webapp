<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YSP Tagum — Member App</title>

  <!-- Fonts & libs -->
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link rel="icon" href="https://i.imgur.com/J4wddTW.png">

  <style>
    /* ---------------- Base / Theme ---------------- */
    :root{
      --primary:#f6421f;
      --secondary:#ee8724;
      --tertiary:#fbcb29;
      --bg-gradient: linear-gradient(135deg,var(--primary),var(--secondary),var(--tertiary));
      --text-dark:#222;
      --text-light:#fff;
      --card-bg:rgba(255,255,255,0.97);
      --card-border:rgba(255,255,255,0.6);
      --muted: rgba(0,0,0,0.54);
      --input-bg: rgba(0,0,0,0.03);
      --input-border: rgba(0,0,0,0.08);
      --shadow-1: 0 6px 18px rgba(0,0,0,0.08);
      --shadow-2: 0 12px 40px rgba(0,0,0,0.12);
      --shadow-3: 0 18px 56px rgba(0,0,0,0.18);
      --success:#34c759;
      --danger:#ff3b30;
      --space-xs: clamp(6px,1.2vh,10px);
      --space-sm: clamp(10px,1.6vh,14px);
      --space-md: clamp(14px,2.4vh,22px);
      --space-lg: clamp(18px,3vh,28px);
      --radius-lg: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0}
    body{
      font-family:"Roboto",sans-serif;
      background:var(--bg-gradient);
      background-size:400% 400%;
      animation: gradientShift 18s linear infinite;
      min-height:100dvh;
      margin:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:clamp(24px,6vw,56px) clamp(16px,4vw,40px);
      color:var(--text-dark);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      gap:var(--space-lg);
      position:relative;
      overflow-x:hidden;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:linear-gradient(160deg,rgba(255,255,255,0.16),rgba(255,255,255,0.04));
      pointer-events:none;
      z-index:0;
    }
    @media (prefers-reduced-motion: reduce){
      body{animation:none;background-size:auto;}
    }
    @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    /* ---------------- App layout ---------------- */
    #app {
      width:min(100%,960px);
      position:relative;
      display:flex;
      flex-direction:column;
      gap:var(--space-lg);
      z-index:1;
    }
    .panel {
      width:100%;
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      padding:clamp(18px,3vw,28px);
      box-shadow:var(--shadow-2);
      border:1px solid var(--card-border);
      display:none;
      flex-direction:column;
      gap:var(--space-md);
      transition: transform .36s cubic-bezier(.2,.9,.2,1), opacity .36s ease;
      overflow:auto;
      max-height:min(900px,calc(100dvh - clamp(72px,14vh,180px)));
      backdrop-filter:blur(6px);
      overscroll-behavior:contain;
      scrollbar-gutter:stable both-edges;
    }
    .panel.panel-wide{ --panel-max: var(--panel-max-wide); }
    .panel.panel-tight{ --panel-max: var(--panel-max-tight); }
    .panel.hidden { opacity:0; pointer-events:none; transform: translateY(10px) scale(.996); display:none !important; }
    .panel.active { opacity:1; pointer-events:all; transform:translateY(0); display:flex !important; z-index:5; }

    /* header/logo/title */
    .panel-header {
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:var(--space-xs);
      text-align:center;
      padding-bottom:var(--space-sm);
      border-bottom:1px solid rgba(0,0,0,0.06);
      margin-bottom:var(--space-sm);
    }
    .panel-header .panel-subtitle{
      font-size:0.95rem;
      color:rgba(0,0,0,0.65);
      margin:0;
    }
    .panel-body{
      width:100%;
      max-width:720px;
      margin-inline:auto;
      display:flex;
      flex-direction:column;
      gap:var(--space-md);
    }
    .panel-body.is-wide{ max-width:840px; }
    .panel-body.is-tight{ max-width:520px; }
    .panel-section{
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
    }
    .form-stack{
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
    }
    .panel-actions{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      gap:var(--space-sm);
    }
    .text-muted{ color:rgba(0,0,0,0.65); }
    .directory-result{ display:flex; flex-direction:column; gap:var(--space-sm); }
    .directory-meta{ display:flex; flex-direction:column; gap:4px; }
    .logo { width:72px; height:72px; object-fit:contain; margin:0 auto; display:block; }
    h1 { font-family:'Lexend',sans-serif; color:var(--primary); font-size:1.5rem; margin:0; text-align:center; }
    h2 { font-family:'Lexend',sans-serif; color:var(--primary); font-size:1.05rem; margin:10px 0 6px; text-align:center; }

    .container{ max-width:1200px; margin:0 auto; padding:0 16px; }

    /* inputs & buttons */
    .input-field, textarea, select {
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--input-border);
      background:var(--input-bg);
      font-size:0.98rem;
      outline:none;
      transition: box-shadow .12s ease, transform .08s ease;
    }
    .input-field:focus,
    textarea:focus,
    select:focus { box-shadow: 0 10px 28px rgba(0,0,0,0.08); transform: translateY(-1px); border-color: rgba(0,0,0,0.18); }
    textarea { min-height:120px; resize:vertical; }

    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 16px;
      border-radius:12px;
      border:0;
      background:var(--primary);
      color:#fff;
      font-family:'Lexend',sans-serif;
      cursor:pointer;
      font-weight:600;
      box-shadow:0 6px 24px rgba(0,0,0,0.12);
      transition: transform .2s ease, box-shadow .2s ease, filter .12s;
      min-height:44px;
      text-align:center;
    }
    .btn-primary {
      background:var(--primary);
      color:#fff;
    }
    .btn.secondary {
      border:2px solid var(--primary);
      color:var(--primary);
      background:rgba(246,66,31,0.05);
      box-shadow:none;
    }
    .btn:hover { transform:translateY(-2px); box-shadow:0 10px 32px rgba(0,0,0,0.18); filter:brightness(1.02); }
    .btn:active { transform:translateY(0); }
    .btn:focus-visible { outline:3px solid rgba(246,66,31,0.35); outline-offset:2px; }

    .button-row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center; }

    /* eye toggle */
    .input-container { position:relative; display:flex; gap:10px; align-items:center; }
    .eye-toggle {
      position:absolute; right:12px; top:50%; transform:translateY(-50%); width:34px; height:34px;
      display:flex; align-items:center; justify-content:center; border-radius:8px; cursor:pointer;
      transition: transform .22s ease, background .18s ease;
    }
    .eye-toggle:hover { transform: translateY(-50%) scale(1.06); background:rgba(0,0,0,0.02) }
    .eye-toggle svg { width:20px; height:20px; stroke:var(--text-dark); fill:none; stroke-width:1.5; transition: transform .18s ease, opacity .18s;}
    .eye-toggle.closed svg { transform: rotate(-8deg) scale(.98); opacity:0.9; }
    .eye-toggle.closed svg .pupil { transform:scale(0); transform-origin:center; transition:transform .12s ease; }

    /* status message */
    .status-message { min-height:22px; font-weight:600; font-size:0.94rem; opacity:0; transition:opacity .18s ease; text-align:center; }
    .status-message.show { opacity:1; }

    /* menu layout */
    #main-menu-buttons { display:flex; flex-direction:column; gap:10px; margin-top:6px; }
    details { border:1px solid var(--input-border); padding:8px; border-radius:10px; background:transparent; }
    details summary { list-style:none; font-family:'Lexend'; cursor:pointer; font-weight:700; }

    /* lists / cards */
    .card {
      background:#fff;
      padding:16px;
      border-radius:12px;
      border:1px solid var(--input-border);
      box-shadow:0 6px 24px rgba(0,0,0,0.08);
    }
    .avatar { width:86px; height:86px; border-radius:50%; object-fit:cover; border:3px solid rgba(0,0,0,0.05); }

    /* homepage content */
    #homepage-panel .panel-body {
      display:flex;
      flex-direction:column;
      min-height:min(100%, calc(100dvh - 180px));
    }
    .homepage-layout { display:flex; flex-direction:column; gap:24px; flex:1; }
    .homepage-layout .container { width:100%; }
    #homepage-content { text-align:justify; line-height:1.55; font-size:0.97rem; color:var(--text-dark); display:flex; flex-direction:column; gap:16px; }
    .homepage-section-block h3 { font-family:'Lexend',sans-serif; margin:0 0 8px; font-size:1.1rem; color:var(--primary); }
    .homepage-section-block p { margin:0; font-size:0.95rem; line-height:1.6; }
    .homepage-lede { font-size:1.05rem; font-weight:500; }
    .homepage-meta { display:flex; flex-direction:column; gap:4px; font-size:0.94rem; }
    .homepage-meta strong { font-family:'Lexend',sans-serif; font-size:1rem; }
    .homepage-org-chart { border-radius:12px; overflow:hidden; background:#fff; }
    .homepage-org-chart img { width:100%; display:block; }
    .homepage-contact-grid { display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
    .homepage-contact-grid .card { display:flex; flex-direction:column; gap:12px; }
    .homepage-contact-grid .card p { margin:0; }
    .homepage-contact-grid .card h3 { font-family:'Lexend',sans-serif; margin:0; font-size:1.1rem; color:var(--primary); }
    .homepage-action-stack { display:flex; flex-wrap:wrap; gap:12px; }
    .panel-actions.push-bottom { margin-top:auto; }
    #project-gallery { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; padding-block:12px; }
    .project-card {
      width:100%;
      border-radius:12px;
      cursor:pointer;
      transition:transform .18s ease, box-shadow .18s ease;
      background:#fff;
      border:1px solid rgba(0,0,0,0.08);
      box-shadow:0 6px 20px rgba(0,0,0,0.08);
      display:flex;
      flex-direction:column;
      text-align:left;
      padding:0;
      color:var(--text-dark);
    }
    .project-card:focus-visible { outline:3px solid rgba(246,66,31,0.35); outline-offset:2px; }
    .project-card__media {
      border-radius:12px 12px 0 0;
      overflow:hidden;
    }
    .project-card__title {
      font-family:'Lexend',sans-serif;
      font-size:1.05rem;
      color:var(--primary);
      margin:12px 12px 4px;
    }
    .project-card__copy {
      margin:0 12px 16px;
      color:var(--text-dark);
      font-size:0.95rem;
    }
    .project-card:hover { transform:translateY(-4px); box-shadow:0 16px 40px rgba(0,0,0,0.14); }

    /* modal */
    .modal-root{ position:relative; }
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.5);
      display:none;
      z-index:1800;
    }
    .modal-backdrop.is-open { display:block; }
    .modal {
      position:fixed;
      inset:0;
      display:grid;
      place-items:center;
      opacity:0;
      transform:scale(.98);
      transition:opacity .22s ease, transform .22s ease;
      pointer-events:none;
      z-index:1810;
      padding:24px;
    }
    .modal.is-open {
      opacity:1;
      transform:scale(1);
      pointer-events:auto;
    }
    .modal__panel {
      width:min(92vw,840px);
      max-height:90dvh;
      overflow:auto;
      background:#fff;
      border-radius:12px;
      box-shadow:0 12px 48px rgba(0,0,0,0.18);
      display:flex;
      flex-direction:column;
      gap:16px;
      padding:clamp(16px,3vw,24px);
    }
    .modal__header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .modal__title {
      font-family:'Lexend',sans-serif;
      font-size:1.3rem;
      margin:0;
      color:var(--primary);
    }
    .modal__close {
      border:0;
      background:transparent;
      color:var(--text-dark);
      font-size:1.2rem;
      cursor:pointer;
      border-radius:8px;
      padding:6px;
    }
    .modal__close:focus-visible { outline:3px solid rgba(246,66,31,0.35); outline-offset:2px; }
    .modal__body { line-height:1.6; font-size:0.98rem; color:var(--text-dark); }
    .modal__footer { display:flex; justify-content:flex-end; }
    .project-modal-body { display:flex; flex-direction:column; gap:16px; }
    .project-modal-media { border-radius:12px; overflow:hidden; }
    .project-modal-media img { width:100%; display:block; }
    .project-modal-copy { display:flex; flex-direction:column; gap:12px; font-size:0.98rem; line-height:1.6; }
    .project-modal-copy p { margin:0; }

    @media (min-width:768px){
      .project-modal-body { flex-direction:row; gap:24px; }
      .project-modal-media, .project-modal-copy { flex:1; }
    }

    .ratio-16x9 { aspect-ratio:16/9; overflow:hidden; border-radius:inherit; }
    .ratio-16x9 img { width:100%; height:100%; object-fit:cover; }

    /* table styles */
    .styled-table { width:100%; border-collapse:collapse; border-radius:10px; overflow:hidden; }
    .styled-table th, .styled-table td { padding:10px 12px; text-align:left; border-bottom:1px solid rgba(0,0,0,0.05); font-size:0.95rem; }
    .styled-table thead th { background:transparent; color:var(--muted); font-weight:700; }
    .styled-table tbody tr:nth-child(even) { background: rgba(0,0,0,0.02); }

    /* announcement badge */
    #ann-badge span { display:inline-block; background:red; color:#fff; padding:6px 10px; border-radius:999px; font-weight:800; font-size:0.85rem; box-shadow:0 6px 12px rgba(255,0,0,0.06); }

    .suggestions-list{
      list-style:none;
      margin:0;
      padding:var(--space-xs);
      display:flex;
      flex-direction:column;
      gap:6px;
      background:rgba(255,255,255,0.72);
      border-radius:14px;
    }
    .suggestion-item{
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      transition:transform .16s ease, box-shadow .16s ease, background .16s ease;
      border:1px solid rgba(0,0,0,0.04);
      background:rgba(255,255,255,0.6);
    }
    .suggestion-item:hover,
    .suggestion-item.is-active{
      transform:translateY(-1px);
      box-shadow:0 10px 24px rgba(0,0,0,0.08);
      background:#fff;
    }

    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    .guest-modal{ display:flex; flex-direction:column; gap:var(--space-sm); }
    .guest-modal__status{ min-height:20px; font-size:0.92rem; color:var(--muted); transition:color .18s ease; }
    .guest-modal__status.is-error{ color:var(--danger); }

    .info-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(210px,1fr));
      gap:var(--space-sm);
    }
    .info-grid .card{ min-height:110px; }

    .media-stack{
      display:flex;
      gap:var(--space-sm);
      align-items:center;
      flex-wrap:wrap;
    }

    .panel-divider{
      height:1px;
      background:rgba(0,0,0,0.06);
      margin:var(--space-xs) 0;
    }

    @media (min-width:1024px){
      body{ padding-block:clamp(36px,8vh,80px); }
      .panel{ box-shadow:var(--shadow-3); }
      .panel-body{ gap:clamp(16px,2vh,28px); }
    }
    @media (max-width:820px){
      body{ padding:clamp(18px,8vw,36px) clamp(14px,6vw,28px); }
      .panel { padding:clamp(16px,4vw,24px); border-radius:16px; max-height:calc(100dvh - 120px); }
      .panel-header{ margin-bottom:var(--space-xs); }
      #project-gallery { gap:10px; }
      .media-stack{ flex-direction:column; text-align:center; }
      .panel-body{ align-items:stretch; }
    }
    @media (max-width:600px){
      .panel{ max-height:none; border-radius:14px; }
      .button-row{ flex-direction:column; align-items:stretch; }
      .panel-actions{ flex-direction:column; align-items:stretch; }
      .logo{ width:60px; height:60px; }
      h1{ font-size:1.35rem; }
      #project-gallery{ grid-template-columns:1fr; }
      .panel-body.is-wide{ max-width:100%; }
    }
    @media (max-width:420px){
      body{ padding:12px; }
      h1{ font-size:1.24rem; }
      .card{ padding:10px; }
    }
  </style>
</head>

<body>
  <main id="app" role="main">

    <!-- LOGIN PANEL -->
    <section id="login-panel" class="panel active" aria-hidden="false">
      <header class="panel-header">
        <img src="https://i.imgur.com/J4wddTW.png" alt="YSP Logo" class="logo">
        <h1>Member Login — Youth Service Philippines</h1>
        <p class="panel-subtitle">Secure access for members and guests.</p>
      </header>

      <div class="panel-body is-tight">
        <div class="form-stack" aria-label="Login form">
          <label class="sr-only" for="username-input">Username</label>
          <input id="username-input" class="input-field" placeholder="Username (as in User Profiles sheet)" autocomplete="username" />
          <div class="input-container">
            <label class="sr-only" for="password-input">Password</label>
            <input id="password-input" type="password" class="input-field" placeholder="Password (Your ID Code)" autocomplete="current-password" />
            <div id="eye-toggle" class="eye-toggle" title="Show or hide password" aria-hidden="false" role="button">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path class="eye-lid" d="M2 12C6 4 18 4 22 12c-4 8-16 8-20 0z" stroke-linecap="round" stroke-linejoin="round"></path>
                <circle class="pupil" cx="12" cy="12" r="3"></circle>
              </svg>
            </div>
          </div>
        </div>

        <p id="login-status" class="status-message" aria-live="polite"></p>

        <div class="panel-actions">
          <button id="login-btn" class="btn" type="button">Log In</button>
          <button id="guest-login-btn" class="btn secondary" type="button">Log in as Guest</button>
        </div>
      </div>
    </section>

    <!-- MAIN MENU -->
    <section id="main-menu-panel" class="panel hidden" aria-hidden="true">
      <header class="panel-header">
        <img src="https://i.imgur.com/J4wddTW.png" alt="YSP Logo" class="logo">
        <h1 id="welcome-message">Welcome</h1>
        <p class="panel-subtitle">Choose a feature to explore your tools.</p>
      </header>

      <div class="panel-body is-wide">
        <div class="media-stack">
          <img id="user-avatar" src="https://via.placeholder.com/120" alt="avatar" class="avatar">
          <div class="panel-section" style="flex:1;">
            <div id="user-details" style="line-height:1.2"></div>
            <div><span id="ann-badge"></span></div>
          </div>
        </div>

        <div class="panel-divider" role="presentation"></div>

        <div id="main-menu-buttons" class="panel-section" aria-live="polite"></div>
      </div>
    </section>

    <!-- SEARCH PANEL -->
    <section id="search-panel" class="panel hidden" aria-hidden="true">
      <header class="panel-header">
        <img src="https://i.imgur.com/J4wddTW.png" class="logo" alt="logo">
        <h1>Search Officer</h1>
        <p class="panel-subtitle">Look up officers by name or ID and manage attendance quickly.</p>
      </header>

      <div class="panel-body">
        <div class="panel-section">
          <label class="sr-only" for="search-input">Search for officer</label>
          <input id="search-input" class="input-field" placeholder="Enter officer's surname or ID..." autocomplete="off" role="combobox" aria-expanded="false" aria-autocomplete="list" aria-controls="suggestions-list" />
        </div>
        <ul id="suggestions-list" class="suggestions-list" role="listbox" hidden></ul>
        <div id="result-box" class="panel-section" aria-live="polite"></div>
        <div class="panel-actions">
          <button class="btn secondary back-btn" data-target="main-menu-panel">Back to Menu</button>
        </div>
      </div>
    </section>

    <!-- HOMEPAGE PANEL -->
    <section id="homepage-panel" class="panel hidden" aria-hidden="true">
      <header class="panel-header">
        <img src="https://i.imgur.com/J4wddTW.png" class="logo" alt="logo">
        <h1>YSP Tagum — Homepage</h1>
        <p class="panel-subtitle">Mission, vision, key projects, and ways to contact the organization.</p>
      </header>

      <div class="panel-body is-wide homepage-layout">
        <div class="container">
          <article id="homepage-content" class="card" aria-live="polite">Loading homepage...</article>
        </div>

        <div class="container">
          <section class="card" aria-labelledby="homepage-projects-title">
            <div class="section-header" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
              <h2 id="homepage-projects-title" style="margin:0;font-family:'Lexend',sans-serif;font-size:1.25rem;color:var(--primary);">Projects Implemented</h2>
              <p class="text-muted" style="margin:0;font-size:0.92rem;">Tap a project card to open the gallery.</p>
            </div>
            <div id="project-gallery"></div>
          </section>
        </div>

        <div class="container">
          <div id="homepage-contacts" class="homepage-contact-grid" aria-live="polite"></div>
        </div>

        <div class="panel-actions push-bottom">
          <button id="homepage-back-btn" class="btn secondary back-btn" data-target="login-panel">Back to Login</button>
        </div>
      </div>
    </section>

    <!-- VIEW FEEDBACK -->
    <section id="view-feedback-panel" class="panel hidden" aria-hidden="true">
      <header class="panel-header">
        <img src="https://i.imgur.com/J4wddTW.png" class="logo" alt="logo">
        <h1>Feedback</h1>
        <p class="panel-subtitle">Read feedback submissions and stay informed on member sentiments.</p>
      </header>
      <div class="panel-body is-wide">
        <div id="feedback-container" class="panel-section"></div>
        <div class="panel-actions"><button class="btn secondary back-btn" data-target="main-menu-panel">Back</button></div>
      </div>
    </section>

    <!-- VIEW LOGS -->
    <section id="view-logs-panel" class="panel hidden" aria-hidden="true">
      <header class="panel-header">
        <img src="https://i.imgur.com/J4wddTW.png" class="logo" alt="logo">
        <h1>Access Logs</h1>
        <p class="panel-subtitle">Monitor sign-ins and audit trails for accountability.</p>
      </header>
      <div class="panel-body is-wide">
        <div id="access-logs-container" class="panel-section"></div>
        <div class="panel-actions"><button class="btn secondary back-btn" data-target="main-menu-panel">Back</button></div>
      </div>
    </section>

    <!-- PROFILE (read-only UI) -->
    <section id="profile-panel" class="panel hidden" aria-hidden="true">
      <header class="panel-header">
        <img src="https://i.imgur.com/J4wddTW.png" class="logo" alt="logo">
        <h1>My Profile</h1>
        <p class="panel-subtitle">Review your membership information, contact details, and biography.</p>
      </header>
      <div class="panel-body is-wide">
        <div id="profile-container" class="panel-section">Loading...</div>
        <div class="panel-actions"><button class="btn secondary back-btn" data-target="main-menu-panel">Back</button></div>
      </div>
    </section>

    <!-- ANNOUNCEMENTS -->
    <section id="announcements-panel" class="panel hidden" aria-hidden="true">
      <header class="panel-header">
        <img src="https://i.imgur.com/J4wddTW.png" class="logo" alt="logo">
        <h1>Announcements</h1>
        <p class="panel-subtitle">Filter updates, send new notices, and keep members informed.</p>
      </header>

      <div class="panel-body is-wide">
        <div class="panel-section" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <label class="sr-only" for="ann-filter">Filter announcements</label>
          <select id="ann-filter" class="input-field" style="flex:1;min-width:180px;max-width:260px;">
            <option value="all">All</option>
            <option value="unread">Unread</option>
            <option value="mine">To me</option>
          </select>
          <button id="create-ann-btn" class="btn">Create Announcement</button>
        </div>

        <div id="ann-list" class="panel-section"></div>

        <div class="panel-actions"><button class="btn secondary back-btn" data-target="main-menu-panel">Back</button></div>
      </div>
    </section>

    <!-- ATTENDANCE TRANSPARENCY -->
    <section id="attendance-trans-panel" class="panel hidden" aria-hidden="true">
      <header class="panel-header">
        <img src="https://i.imgur.com/J4wddTW.png" class="logo" alt="logo">
        <h1>Attendance Transparency</h1>
        <p class="panel-subtitle">Review your time-in and time-out history for every event.</p>
      </header>
      <div class="panel-body is-wide">
        <p class="text-muted" style="margin:0">View your attendance records (Date, Event, Time In, Time Out).</p>
        <div id="attendance-table" class="panel-section"></div>
        <div class="panel-actions"><button class="btn secondary back-btn" data-target="main-menu-panel">Back</button></div>
      </div>
    </section>

    <!-- Modal root -->
    <div id="modal-root" class="modal-root" hidden></div>
  </main>

  <!-- ---------------- JS: UI logic ---------------- -->
  <script>
  (function(){
    function onReady(fn){
      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', fn);
      } else {
        fn();
      }
    }

    onReady(function(){
    // Shortcuts + state
    function $(s){ return document.querySelector(s); }
    function $$(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }
    const panels = $$('.panel');
    const panelHashMap = {
      'login-panel': '#login',
      'main-menu-panel': '#dashboard',
      'homepage-panel': '#homepage',
      'search-panel': '#search',
      'announcements-panel': '#announcements',
      'view-feedback-panel': '#feedback',
      'view-logs-panel': '#logs',
      'attendance-trans-panel': '#attendance'
    };
    let appState = {
      currentUser: null,
      officerData: [],
      events: [],
      announcements: [],
      unreadCount: 0
    };

    // Elements
    const loginPanel = $('#login-panel');
    const loginBtn = $('#login-btn');
    const guestLoginBtn = $('#guest-login-btn');
    const usernameInput = $('#username-input');
    const passwordInput = $('#password-input');
    const eyeToggle = $('#eye-toggle');
    const loginStatus = $('#login-status');

    const mainMenuPanel = $('#main-menu-panel');
    const welcomeMessage = $('#welcome-message');
    const userDetailsDiv = $('#user-details');
    const userAvatar = $('#user-avatar');
    const mainMenuButtons = $('#main-menu-buttons');
    const annBadge = $('#ann-badge');

    const homepagePanel = $('#homepage-panel');
    const homepageContent = $('#homepage-content');
    const projectGallery = $('#project-gallery');
    const homepageContacts = $('#homepage-contacts');

    const searchPanel = $('#search-panel');
    const searchInput = $('#search-input');
    const suggestionsList = $('#suggestions-list');
    const resultBox = $('#result-box');

    const feedbackContainer = $('#feedback-container');
    const logsContainer = $('#access-logs-container');
    const profileContainer = $('#profile-container');

    const announcementsPanel = $('#announcements-panel');
    const annList = $('#ann-list');
    const createAnnBtn = $('#create-ann-btn');
    const annFilter = $('#ann-filter');

    const attendanceTransPanel = $('#attendance-trans-panel');
    const attendanceTable = $('#attendance-table');


    const modalRoot = $('#modal-root');
    const modalState = {
      escListener: null,
      trapCleanup: null,
      lastFocused: null,
      backdrop: null,
      modal: null,
      panel: null
    };
    const htmlEscapeMap = { "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" };
    function escapeHtml(value){
      const normalized = value == null ? '' : value;
      return String(normalized).replace(/[&<>"']/g, function(ch){ return htmlEscapeMap[ch] || ch; });
    }
    function escapeAttr(value){ return escapeHtml(value); }
    function textOrEmpty(value){ return typeof value === 'string' ? value.trim() : ''; }
    function isValidHttpUrl(value){
      try {
        const parsed = new URL(value);
        return parsed.protocol === 'http:' || parsed.protocol === 'https:';
      } catch(e){
        return false;
      }
    }
    function normalizeExternalUrl(value){
      const raw = textOrEmpty(value);
      if(!raw) return '';
      const withProtocol = /^https?:\/\//i.test(raw) ? raw : `https://${raw}`;
      if(!isValidHttpUrl(withProtocol)) return '';
      try {
        return new URL(withProtocol).toString();
      } catch(err){
        return '';
      }
    }
    function safeImageUrl(candidate, fallback){
      const fallbackUrl = fallback || 'https://via.placeholder.com/960x540?text=YSP';
      if(candidate && isValidHttpUrl(candidate)){
        try {
          return new URL(candidate).toString();
        } catch(e){
          return fallbackUrl;
        }
      }
      return fallbackUrl;
    }
    function buildGmailComposeUrl(email){
      const safeEmail = textOrEmpty(email);
      if(!safeEmail) return '';
      const compose = new URL('https://mail.google.com/mail/');
      compose.searchParams.set('view','cm');
      compose.searchParams.set('fs','1');
      compose.searchParams.set('to', safeEmail);
      compose.searchParams.set('su','[YSP] Issue Report');
      return compose.toString();
    }
    function openExternal(url){
      const safeUrl = normalizeExternalUrl(url);
      if(!safeUrl) return;
      try {
        const win = window.open(safeUrl, '_blank', 'noopener');
        if(win){ win.opener = null; }
      } catch(err){
        console.warn('Unable to open link', err);
      }
    }

    // Utilities
    function switchPanels(targetId){
      panels.forEach(function(p){
        if(p.id === targetId){
          p.classList.remove('hidden');
          p.classList.add('active');
          p.style.display = 'flex';
          p.setAttribute('aria-hidden','false');
        } else {
          p.classList.add('hidden');
          p.classList.remove('active');
          p.setAttribute('aria-hidden','true');
          p.style.display = 'none';
        }
      });
      // small scroll to top for panel
      const t = $('#'+targetId);
      if(t) t.scrollTop = 0;
      const hash = panelHashMap[targetId];
      if(hash){
        location.hash = hash;
      }
    }

    function showStatusFor(idSelectorOrText, text, timeout){
      const numericTimeout = typeof timeout === 'number' ? timeout : Number(timeout);
      const displayDuration = !isNaN(numericTimeout) ? numericTimeout : 4200;
      // convenience: if idSelectorOrText equals 'login' show in login-status
      const el = (typeof idSelectorOrText === 'string' && idSelectorOrText.startsWith('#')) ? document.querySelector(idSelectorOrText) : document.getElementById(idSelectorOrText + '-status');
      const target = el || (typeof idSelectorOrText === 'string' ? document.getElementById(idSelectorOrText) : null);
      if(target){
        target.textContent = text;
        target.classList.add('show');
        setTimeout(function(){ target.classList.remove('show'); }, displayDuration);
      } else {
        console.warn('Status element not found for', idSelectorOrText);
      }
    }

    // modal helper
    function showModal(options){
      const opts = options || {};
      const title = typeof opts.title === 'string' ? opts.title : '';
      const bodyHtml = typeof opts.bodyHtml === 'string' ? opts.bodyHtml : '';
      const footerHtml = typeof opts.footerHtml === 'string' ? opts.footerHtml : '';
      const modalClass = typeof opts.modalClass === 'string' ? opts.modalClass : '';
      const opener = opts.opener || null;
      if(!modalRoot) return;
      if(!modalRoot.hidden){
        if(modalState.escListener){
          document.removeEventListener('keydown', modalState.escListener);
          modalState.escListener = null;
        }
        if(modalState.trapCleanup){
          modalState.trapCleanup();
          modalState.trapCleanup = null;
        }
        modalRoot.innerHTML = '';
        modalRoot.hidden = true;
        modalState.backdrop = null;
        modalState.modal = null;
        modalState.panel = null;
      }

      modalState.lastFocused = opener || document.activeElement;

      const titleId = `modal-title-${Date.now()}`;
      const descId = `modal-desc-${Date.now()}`;

      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop';

      const modal = document.createElement('div');
      modal.className = 'modal';
      if(modalClass){ modal.classList.add(modalClass); }

      const panel = document.createElement('div');
      panel.className = 'modal__panel';
      panel.setAttribute('role', 'dialog');
      panel.setAttribute('aria-modal', 'true');
      panel.setAttribute('aria-labelledby', titleId);
      panel.setAttribute('aria-describedby', descId);

      const header = document.createElement('div');
      header.className = 'modal__header';

      const heading = document.createElement('h2');
      heading.className = 'modal__title';
      heading.id = titleId;
      heading.textContent = title || 'Dialog';

      const closeButton = document.createElement('button');
      closeButton.type = 'button';
      closeButton.className = 'modal__close';
      closeButton.setAttribute('aria-label', 'Close dialog');
      closeButton.innerHTML = '&times;';
      closeButton.addEventListener('click', function(){ closeModal(); });

      header.append(heading, closeButton);

      const body = document.createElement('div');
      body.className = 'modal__body';
      body.id = descId;
      body.innerHTML = bodyHtml;

      const footer = document.createElement('div');
      footer.className = 'modal__footer';
      footer.innerHTML = footerHtml;
      footer.querySelectorAll('[data-modal-close]').forEach(function(el){
        if(el.tagName === 'BUTTON' && !el.hasAttribute('type')){
          el.setAttribute('type','button');
        }
        el.addEventListener('click', function(){ closeModal(); });
      });

      panel.append(header, body, footer);
      modal.append(panel);

      modalRoot.innerHTML = '';
      modalRoot.append(backdrop, modal);
      modalRoot.hidden = false;

      requestAnimationFrame(function(){
        backdrop.classList.add('is-open');
        modal.classList.add('is-open');
      });

      const focusableSelectors = 'a[href], area[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex="-1"])';
      let focusables = Array.from(panel.querySelectorAll(focusableSelectors)).filter(function(el){ return el.offsetParent !== null || el === closeButton; });
      if(!focusables.length){
        panel.setAttribute('tabindex', '-1');
        focusables = [panel];
      }
      focusables[0].focus();

      const trapHandler = function(event){
        if(event.key !== 'Tab') return;
        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        if(event.shiftKey && document.activeElement === first){
          event.preventDefault();
          last.focus();
        } else if(!event.shiftKey && document.activeElement === last){
          event.preventDefault();
          first.focus();
        }
      };
      panel.addEventListener('keydown', trapHandler);
      modalState.trapCleanup = function(){ panel.removeEventListener('keydown', trapHandler); };

      backdrop.addEventListener('click', function(event){
        if(event.target === backdrop){
          closeModal();
        }
      });

      const escListener = function(event){
        if(event.key === 'Escape'){
          event.preventDefault();
          closeModal();
        }
      };
      document.addEventListener('keydown', escListener);

      modalState.escListener = escListener;
      modalState.backdrop = backdrop;
      modalState.modal = modal;
      modalState.panel = panel;
    }

    function closeModal(options){
      if(!modalRoot || modalRoot.hidden) return;
      const opts = options || {};
      const skipFocusRestore = !!opts.skipFocusRestore;
      const focusTarget = modalState.lastFocused;

      if(modalState.escListener){
        document.removeEventListener('keydown', modalState.escListener);
        modalState.escListener = null;
      }
      if(modalState.trapCleanup){
        modalState.trapCleanup();
        modalState.trapCleanup = null;
      }

      if(modalState.backdrop){
        modalState.backdrop.classList.remove('is-open');
      }
      if(modalState.modal){
        modalState.modal.classList.remove('is-open');
      }

      setTimeout(function(){
        modalRoot.innerHTML = '';
        modalRoot.hidden = true;
        modalState.backdrop = null;
        modalState.modal = null;
        modalState.panel = null;
        modalState.lastFocused = null;
        if(!skipFocusRestore && focusTarget && typeof focusTarget.focus === 'function'){
          focusTarget.focus();
        }
      }, 220);
    }

    // ---------------- Login flow ----------------
    function handleLogin(){
      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();
      if(!username || !password){
        showStatusFor('login', 'Please enter username & password');
        return;
      }
      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';

      if(!window.google || !google.script){
        // Local preview
        setTimeout(function(){
          loginBtn.disabled = false;
          loginBtn.textContent = 'Log In';
          showStatusFor('login', 'Local preview: google.script.run not available. Deploy to Apps Script to test login.');
        }, 400);
        return;
      }

      google.script.run.withSuccessHandler(function(resp){
        loginBtn.disabled = false;
        loginBtn.textContent = 'Log In';
        if(resp && resp.success){
          appState.currentUser = resp.user;
          populateAfterLogin();
        } else {
          showStatusFor('login', resp && resp.message ? resp.message : 'Invalid credentials');
        }
      }).withFailureHandler(function(err){
        loginBtn.disabled = false;
        loginBtn.textContent = 'Log In';
        console.error('checkLogin failed', err);
        showStatusFor('login', 'Could not connect to server');
      }).checkLogin({ username, password });
    }

    function handleGuestLogin(){
      showModal({
        title: 'Guest Access',
        modalClass: 'guest-modal-shell',
        bodyHtml: `
          <div class="guest-modal">
            <p>Enter your full name so we can record your visit in the access logs.</p>
            <label for="guest-name-input" style="font-weight:600">Full Name</label>
            <input id="guest-name-input" class="input-field" type="text" placeholder="e.g. Juan Dela Cruz" autocomplete="name" />
            <p id="guest-modal-status" class="guest-modal__status" role="status" aria-live="polite"></p>
          </div>
        `,
        footerHtml: `
          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
            <button type="button" class="btn secondary" data-modal-close="true">Cancel</button>
            <button type="button" class="btn" id="guest-continue-btn">Continue as Guest</button>
          </div>
        `,
        opener: guestLoginBtn
      });

      requestAnimationFrame(function(){
        const nameInput = document.getElementById('guest-name-input');
        const continueBtn = document.getElementById('guest-continue-btn');
        const statusEl = document.getElementById('guest-modal-status');
        if(nameInput){
          nameInput.focus();
        }
        function completeGuestLogin(guestName){
          appState.currentUser = { name: guestName, role: 'Guest', idCode: 'Visitor', position: 'Guest' };
          closeModal({ skipFocusRestore: true });
          loadHomepage();
          switchPanels('homepage-panel');
        }
        function logAndContinue(guestName){
          if(window.google && google.script && google.script.run){
            google.script.run
              .withSuccessHandler(function(){ completeGuestLogin(guestName); })
              .withFailureHandler(function(err){
                console.warn('Guest logAccess failed', err);
                completeGuestLogin(guestName);
              })
              .logAccess({ idCode: 'Visitor', name: guestName });
          } else {
            completeGuestLogin(guestName);
          }
        }
        function handleContinue(){
          if(!nameInput || !continueBtn) return;
          const guestName = (nameInput.value || '').trim();
          if(!guestName){
            if(statusEl){
              statusEl.textContent = 'Please enter your name to continue.';
              statusEl.classList.add('is-error');
            }
            nameInput.focus();
            return;
          }
          if(statusEl){
            statusEl.textContent = 'Signing you in as a guest…';
            statusEl.classList.remove('is-error');
          }
          continueBtn.disabled = true;
          continueBtn.textContent = 'Signing in…';
          logAndContinue(guestName);
        }
        if(continueBtn){
          continueBtn.addEventListener('click', handleContinue);
        }
        if(nameInput){
          nameInput.addEventListener('keydown', function(evt){
            if(evt.key === 'Enter'){
              evt.preventDefault();
              handleContinue();
            }
          });
        }
      });
    }

    // Eye toggle
    eyeToggle.addEventListener('click', function(){
      if(passwordInput.type === 'password'){
        passwordInput.type = 'text';
        eyeToggle.classList.add('closed');
      } else {
        passwordInput.type = 'password';
        eyeToggle.classList.remove('closed');
      }
    });

    // ---------------- After login ----------------
    function populateAfterLogin(){
      const u = appState.currentUser || {};
      const shortName = u.name ? (u.name.split(',')[0] || u.name) : 'Member';
      welcomeMessage.textContent = `Welcome, ${shortName}`;
      userDetailsDiv.innerHTML = `
        <p style="margin:0"><strong>${u.name||''}</strong></p>
        <p style="margin:6px 0 0 0"><small>${u.position||''} • ${u.role||''}</small></p>
        <p style="margin:6px 0 0 0;opacity:.8"><small>ID: ${u.idCode||''}</small></p>
      `;
      // avatar
      if(window.google && google.script){
        google.script.run.withSuccessHandler(function(profile){
          if(profile && profile.ProfilePictureURL){
            userAvatar.src = safeImageUrl(profile.ProfilePictureURL, 'https://via.placeholder.com/120');
          }
        }).withFailureHandler(function(err){ console.warn('Profile image fetch failed', err); }).getUserProfile(u.idCode);
      }
      buildDynamicMenus();
      loadUnreadAnnouncements();
      switchPanels('main-menu-panel');

      // Preload officer data & events for privileged roles
      if(['Admin','Auditor','Head'].includes(u.role) && window.google && google.script){
        google.script.run.withSuccessHandler(function(res){ if(res && res.success) appState.officerData = res.data || []; }).withFailureHandler(function(err){ console.warn('getOfficerData failed', err); }).getOfficerData();
        google.script.run.withSuccessHandler(function(res){ if(res && res.success) appState.events = res.data || []; }).withFailureHandler(function(err){ console.warn('getEvents failed', err); }).getEvents();
      }
    }

    // ---------------- Build dynamic menu ----------------
    function buildDynamicMenus(){
      mainMenuButtons.innerHTML = '';
      const u = appState.currentUser || {};

      // Homepage
      const homepageBtn = document.createElement('button'); homepageBtn.className='btn secondary'; homepageBtn.textContent='Homepage';
      homepageBtn.onclick = function(){ loadHomepage(); switchPanels('homepage-panel'); };
      mainMenuButtons.appendChild(homepageBtn);

      // Attendance details
      const attendanceDetails = document.createElement('details');
      attendanceDetails.innerHTML = `<summary>Attendance System</summary>`;
      const btnMyQr = document.createElement('button'); btnMyQr.className='btn secondary'; btnMyQr.textContent='My QR ID';
      btnMyQr.onclick = function(){ showMyQr(); };
      attendanceDetails.appendChild(btnMyQr);

      if(['Admin','Auditor','Head'].includes(u.role)){
        const btnScan = document.createElement('button'); btnScan.className='btn secondary'; btnScan.textContent='Open Scanner (separate page)';
        btnScan.onclick = function(){
          // web apps: instruct to open scanner link (server can provide URL)
          if(window.google && google.script){
            // optionally open separate page if backend exposes a URL; otherwise notify user
            google.script.run
              .withSuccessHandler(function(url){
                if(url && typeof url === 'string') {
                  window.open(url, '_blank', 'noopener');
                } else {
                  alert('QR Scanner is a separate page. Open QRScanner.html in a new tab (deployed web app) or use the scanner in Admin console.');
                }
              })
              .withFailureHandler(function(err){
                console.error('getQrScannerUrl failed', err);
                alert('QR Scanner link unavailable. Please open the deployed scanner manually.');
              })
              .getQrScannerUrl();
          } else {
            alert('Open QRScanner.html (local preview cannot open Apps Script page).');
          }
        };
        attendanceDetails.appendChild(btnScan);

        const btnManual = document.createElement('button'); btnManual.className='btn secondary'; btnManual.textContent='Manual Attendance';
        btnManual.onclick = function(){
          // use the search panel to find a person and mark status — simplified to redirect to search for manual marking
          switchPanels('search-panel');
          // instruction: admins can search and then a UI will call manual attendance backend
        };
        attendanceDetails.appendChild(btnManual);
      }
      mainMenuButtons.appendChild(attendanceDetails);

      // Analytics & Admin
      const analytics = document.createElement('details'); analytics.innerHTML = `<summary>Analytics & Admin</summary>`;
      if(['Admin','Auditor','Head'].includes(u.role)){
        const dirBtn = document.createElement('button'); dirBtn.className='btn secondary'; dirBtn.textContent='Officer Directory Search';
          dirBtn.onclick = function(){ switchPanels('search-panel'); };
        analytics.appendChild(dirBtn);
      }
      if(['Admin','Auditor'].includes(u.role)){
        const dashBtn = document.createElement('button'); dashBtn.className='btn secondary'; dashBtn.textContent='Attendance Dashboard';
          dashBtn.onclick = function(){ switchPanels('attendance-trans-panel'); loadAttendanceTransparency(); };
        analytics.appendChild(dashBtn);

        const manageBtn = document.createElement('button'); manageBtn.className='btn secondary'; manageBtn.textContent='Manage Events';
          manageBtn.onclick = function(){ alert('Event creation is done within the Admin Google Sheet (Master Attendance Log columns).'); };
        analytics.appendChild(manageBtn);

        const viewFeedbackBtn = document.createElement('button'); viewFeedbackBtn.className='btn secondary'; viewFeedbackBtn.textContent='View Feedback';
          viewFeedbackBtn.onclick = function(){ loadFeedback(); switchPanels('view-feedback-panel'); };
        analytics.appendChild(viewFeedbackBtn);
      }
      if(u.role === 'Auditor'){
        const logsBtn = document.createElement('button'); logsBtn.className='btn secondary'; logsBtn.textContent='View Access Logs';
          logsBtn.onclick = function(){ loadAccessLogs(); switchPanels('view-logs-panel'); };
        analytics.appendChild(logsBtn);
      }
      if(analytics.querySelectorAll(':scope > *').length>1) mainMenuButtons.appendChild(analytics);

      // Announcements
      const annBtn = document.createElement('button'); annBtn.className='btn secondary'; annBtn.textContent='Announcements';
        annBtn.onclick = function(){ loadAnnouncements(); switchPanels('announcements-panel'); };
      mainMenuButtons.appendChild(annBtn);

      // Feedback
      const feedbackBtn = document.createElement('button'); feedbackBtn.className='btn'; feedbackBtn.textContent='Submit Feedback';
        feedbackBtn.onclick = function(){ switchPanels('view-feedback-panel'); loadFeedback(); };
      mainMenuButtons.appendChild(feedbackBtn);

      // Profile
      const profileBtn = document.createElement('button'); profileBtn.className='btn secondary'; profileBtn.textContent='My Profile';
        profileBtn.onclick = function(){ loadUserProfile(); switchPanels('profile-panel'); };
      mainMenuButtons.appendChild(profileBtn);

      // Logout
      const logoutBtn = document.createElement('button'); logoutBtn.className='btn secondary'; logoutBtn.textContent='Log Out';
        logoutBtn.onclick = function(){ handleLogout(); };
      mainMenuButtons.appendChild(logoutBtn);
    }

    function handleLogout(){
      appState.currentUser = null;
      usernameInput.value = ''; passwordInput.value = '';
      passwordInput.type = 'password';
      eyeToggle.classList.remove('closed');
      switchPanels('login-panel');
    }

    // ---------------- Homepage ----------------


    function loadHomepage(){
      if(homepageContent){
        homepageContent.classList.remove('text-muted');
        homepageContent.textContent = 'Loading…';
      }
      projectGallery.innerHTML = '';
      if(homepageContacts){ homepageContacts.innerHTML = ''; }

      function renderStatus(message){
        if(homepageContent){
          homepageContent.innerHTML = '';
          const info = document.createElement('p');
          info.className = 'text-muted';
          info.textContent = message;
          homepageContent.appendChild(info);
        }
        projectGallery.innerHTML = '';
      }

      function renderContacts(content, options){
        const opts = options || {};
        const offline = !!opts.offline;
        if(!homepageContacts) return;
        homepageContacts.innerHTML = '';

        const issueCard = document.createElement('article');
        issueCard.className = 'card';
        const issueTitle = document.createElement('h3');
        issueTitle.textContent = 'Report Issues via FB/Email';
        const issueBody = document.createElement('p');
        issueBody.textContent = offline ? 'Contact links become active once connected to Google Apps Script.' : 'Reach the Youth Service Philippines Tagum Chapter through the official channels for support.';
        issueCard.append(issueTitle, issueBody);

        const actionStack = document.createElement('div');
        actionStack.className = 'homepage-action-stack';
        let hasActions = false;

        const facebookLink = normalizeExternalUrl(content.facebookUrl);
        if(facebookLink){
          const fbBtn = document.createElement('button');
          fbBtn.type = 'button';
          fbBtn.className = 'btn btn-primary';
          fbBtn.textContent = 'Open Facebook Page';
          fbBtn.setAttribute('aria-label', 'Open the YSP Tagum Facebook page in a new tab');
          fbBtn.addEventListener('click', function(){ openExternal(facebookLink); });
          actionStack.appendChild(fbBtn);
          hasActions = true;
        }

        if(content.email){
          const composeUrl = buildGmailComposeUrl(content.email);
          if(composeUrl){
            const emailBtn = document.createElement('button');
            emailBtn.type = 'button';
            emailBtn.className = 'btn btn-primary';
            emailBtn.textContent = 'Email YSP';
            emailBtn.setAttribute('aria-label', 'Compose an email to YSP Tagum');
            emailBtn.addEventListener('click', function(){ openExternal(composeUrl); });
            actionStack.appendChild(emailBtn);
            hasActions = true;
          }
        }

        if(hasActions){
          issueCard.appendChild(actionStack);
        } else {
          const waitMessage = document.createElement('p');
          waitMessage.className = 'text-muted';
          waitMessage.textContent = offline ? 'Actions unavailable in local preview.' : 'Contact links will appear once provided.';
          issueCard.appendChild(waitMessage);
        }

        const devCard = document.createElement('article');
        devCard.className = 'card';
        const devTitle = document.createElement('h3'); devTitle.textContent = 'Web App Developer';
        const devName = document.createElement('p'); devName.textContent = 'Ezequiel John B. Crisostomo';
        const devRole = document.createElement('p'); devRole.textContent = 'Membership and Internal Affairs Officer';
        const devContact = document.createElement('p'); devContact.textContent = 'Facebook/Messenger: Ezequiel Crisostomo';
        const devNote = document.createElement('p'); devNote.textContent = 'Maintains the YSP Tagum web platform and supports technical inquiries.';
        devCard.append(devTitle, devName, devRole, devContact, devNote);

        homepageContacts.append(issueCard, devCard);
      }

      function renderProjects(projects){
        projectGallery.innerHTML = '';
        if(!projects.length){
          const empty = document.createElement('p');
          empty.className = 'text-muted';
          empty.textContent = 'No projects yet.';
          projectGallery.appendChild(empty);
          return;
        }

        projects.forEach(function(project, index){
          const title = textOrEmpty(project.title) || `Project ${index + 1}`;
          const description = textOrEmpty(project.description);
          const imageUrl = safeImageUrl(project.imageUrl, 'https://via.placeholder.com/960x540?text=YSP+Project');

          const card = document.createElement('button');
          card.type = 'button';
          card.className = 'project-card';
          card.setAttribute('aria-label', `View more about ${title}`);

          const media = document.createElement('div');
          media.className = 'project-card__media ratio-16x9';
          const img = document.createElement('img');
          img.loading = 'lazy';
          img.alt = `${title} photo`;
          img.src = imageUrl;
          media.appendChild(img);

          const heading = document.createElement('p');
          heading.className = 'project-card__title';
          heading.textContent = title;

          const copy = document.createElement('p');
          copy.className = 'project-card__copy';
          copy.textContent = description ? description.split(/\n+/)[0] : 'Tap to preview details.';

          card.append(media, heading, copy);

          const openProject = function(){
            const bodyParts = description
              ? description.split(/\n+/).map(function(line){
                  const trimmed = line.trim();
                  return trimmed ? `<p>${escapeHtml(trimmed)}</p>` : '';
                }).filter(Boolean).join('')
              : '<p>Details coming soon.</p>';
            const modalImage = escapeAttr(imageUrl || 'https://via.placeholder.com/960x540?text=YSP+Project');
            showModal({
              title,
              modalClass: 'project-modal',
              bodyHtml: `<div class="project-modal-body"><div class="project-modal-media ratio-16x9"><img src="${modalImage}" alt="${escapeAttr(title)}"></div><div class="project-modal-copy">${bodyParts}</div></div>`,
              footerHtml: '<button type="button" class="btn secondary" data-modal-close="true">Back</button>',
              opener: card
            });
          };
          card.addEventListener('click', openProject);
          card.addEventListener('keydown', function(evt){
            if(evt.key === 'Enter' || evt.key === ' '){
              evt.preventDefault();
              openProject();
            }
          });

          projectGallery.appendChild(card);
        });
      }

      function normalizeContent(raw){
        const source = raw || {};
        const normalized = {
          about: textOrEmpty(source.aboutYSP || source.about),
          mission: textOrEmpty(source.mission),
          vision: textOrEmpty(source.vision),
          objectives: textOrEmpty(source.objectives),
          founderName: textOrEmpty(source.founderName),
          orgChartUrl: textOrEmpty(source.orgChartUrl),
          facebookUrl: textOrEmpty(source.facebookUrl),
          email: textOrEmpty(source.email),
          projects: []
        };

        const incomingProjects = Array.isArray(source.projects) ? source.projects : [];
        if(incomingProjects.length){
          normalized.projects = incomingProjects.map(function(proj, idx){
            return {
              title: textOrEmpty(proj.title) || `Project ${idx + 1}`,
              description: textOrEmpty(proj.description),
              imageUrl: textOrEmpty(proj.imageUrl)
            };
          }).filter(function(p){ return p.description || p.imageUrl; });
        } else {
          let index = 1;
          const derived = [];
          while(source[`projectImageUrl_${index}`] || source[`projectDesc_${index}`]){
            derived.push({
              title: `Project ${index}`,
              description: textOrEmpty(source[`projectDesc_${index}`]),
              imageUrl: textOrEmpty(source[`projectImageUrl_${index}`])
            });
            index += 1;
          }
          normalized.projects = derived.filter(function(p){ return p.description || p.imageUrl; });
        }
        return normalized;
      }

      function renderOverview(content){
        if(!homepageContent) return;
        homepageContent.innerHTML = '';
        const fragment = document.createDocumentFragment();

        if(content.about){
          const about = document.createElement('p');
          about.className = 'homepage-lede';
          about.textContent = content.about;
          fragment.appendChild(about);
        }

        if(content.founderName){
          const founder = document.createElement('p');
          founder.className = 'homepage-lede';
          const label = document.createElement('strong');
          label.textContent = 'Founder:';
          founder.append(label, document.createTextNode(` ${content.founderName}`));
          fragment.appendChild(founder);
        }

        const blockFromText = function(title, value){
          if(!value) return;
          const block = document.createElement('div');
          block.className = 'homepage-section-block';
          const heading = document.createElement('h3');
          heading.textContent = title;
          block.appendChild(heading);
          const para = document.createElement('p');
          para.textContent = value;
          block.appendChild(para);
          fragment.appendChild(block);
        };

        blockFromText('Mission', content.mission);
        blockFromText('Vision', content.vision);

        if(content.objectives){
          const block = document.createElement('div');
          block.className = 'homepage-section-block';
          const heading = document.createElement('h3');
          heading.textContent = 'Objectives';
          block.appendChild(heading);
          const items = content.objectives.split(/\n|•|\u2022/).map(function(item){ return item.trim(); }).filter(Boolean);
          if(items.length > 1){
            const list = document.createElement('ul');
            list.style.paddingLeft = '20px';
            list.style.margin = '0';
            items.forEach(function(text){
              const li = document.createElement('li');
              li.textContent = text;
              list.appendChild(li);
            });
            block.appendChild(list);
          } else {
            const para = document.createElement('p');
            para.textContent = content.objectives;
            block.appendChild(para);
          }
          fragment.appendChild(block);
        }

        if(content.orgChartUrl){
          const block = document.createElement('div');
          block.className = 'homepage-section-block';
          const heading = document.createElement('h3');
          heading.textContent = 'Organizational Chart';
          block.appendChild(heading);
          const figure = document.createElement('div');
          figure.className = 'homepage-org-chart ratio-16x9';
          const img = document.createElement('img');
          img.loading = 'lazy';
          img.alt = 'YSP Tagum organizational chart';
          img.src = safeImageUrl(content.orgChartUrl, 'https://via.placeholder.com/1280x720?text=YSP+Org+Chart');
          figure.appendChild(img);
          block.appendChild(figure);
          fragment.appendChild(block);
        }

        if(!fragment.childNodes.length){
          const empty = document.createElement('p');
          empty.className = 'text-muted';
          empty.textContent = 'No homepage content yet.';
          fragment.appendChild(empty);
        }

        homepageContent.appendChild(fragment);
      };

      if(!window.google || !google.script){
        renderStatus('Local preview: homepage backend not available.');
        renderContacts({ facebookUrl: '', email: '' }, { offline: true });
        const offlineProjects = document.createElement('p');
        offlineProjects.className = 'text-muted';
        offlineProjects.textContent = 'Projects load once connected.';
        projectGallery.appendChild(offlineProjects);
        return;
      }

      google.script.run
        .withSuccessHandler(function(res){
          if(!res || !res.success){
            renderStatus('Could not load homepage content.');
            renderContacts({ facebookUrl: '', email: '' });
            renderProjects([]);
            return;
          }
          const normalized = normalizeContent(res.data || {});
          renderOverview(normalized);
          renderContacts(normalized);
          renderProjects(normalized.projects);
        })
        .withFailureHandler(function(err){
          console.error('getHomepageContent failed', err);
          renderStatus('Could not load homepage content.');
          renderContacts({ facebookUrl: '', email: '' });
          renderProjects([]);
        })
        .getHomepageContent();
    }

    // ---------------- Directory search ----------------
    let suggestionMatches = [];
    let highlightedIndex = -1;

    function clearSuggestions(){
      suggestionMatches = [];
      highlightedIndex = -1;
      suggestionsList.innerHTML = '';
      suggestionsList.hidden = true;
      if(searchInput){
        searchInput.setAttribute('aria-expanded','false');
        searchInput.removeAttribute('aria-activedescendant');
      }
    }

    function setActiveSuggestion(newIndex){
      const items = suggestionsList.querySelectorAll('.suggestion-item');
      items.forEach(function(item, idx){
        if(idx === newIndex){
          item.classList.add('is-active');
          item.setAttribute('aria-selected','true');
          item.scrollIntoView({ block:'nearest' });
        } else {
          item.classList.remove('is-active');
          item.setAttribute('aria-selected','false');
        }
      });
      highlightedIndex = newIndex;
      if(searchInput){
        if(newIndex >= 0){
          searchInput.setAttribute('aria-activedescendant', `suggestion-${newIndex}`);
        } else {
          searchInput.removeAttribute('aria-activedescendant');
        }
      }
    }

    function selectSuggestion(index){
      const choice = suggestionMatches[index];
      if(choice){
        displayResult(choice);
        clearSuggestions();
      }
    }

    function renderSuggestions(matches){
      suggestionsList.innerHTML = '';
      if(!matches.length){
        clearSuggestions();
        return;
      }
      suggestionMatches = matches.slice(0,10);
      suggestionsList.hidden = false;
      searchInput.setAttribute('aria-expanded','true');
      suggestionMatches.forEach(function(o, idx){
        const li = document.createElement('li');
        li.className = 'suggestion-item';
        li.textContent = `${o[1] || ''} • ${o[2] || ''} (${o[0] || ''})`;
        li.setAttribute('role','option');
        li.setAttribute('id', `suggestion-${idx}`);
        li.setAttribute('aria-selected','false');
        li.dataset.index = idx;
        li.addEventListener('mouseenter', function(){ setActiveSuggestion(idx); });
        li.addEventListener('mousedown', function(event){ event.preventDefault(); });
        li.addEventListener('click', function(){ selectSuggestion(idx); });
        suggestionsList.appendChild(li);
      });
      setActiveSuggestion(0);
    }

    function handleSearchInput(e){
      const q = e.target.value.trim().toLowerCase();
      resultBox.innerHTML = '';
      if(!q || !appState.officerData || !appState.officerData.length){
        clearSuggestions();
        return;
      }
      const matches = appState.officerData.filter(function(r){
        return (r[0]||'').toString().toLowerCase().includes(q) || (r[1]||'').toString().toLowerCase().includes(q);
      });
      if(!matches.length){
        clearSuggestions();
        resultBox.innerHTML = '<p class="text-muted" style="margin:0">No officers found for that search.</p>';
        return;
      }
      renderSuggestions(matches);
    }

    function handleSearchKeydown(e){
      if(!suggestionMatches.length) return;
      if(e.key === 'ArrowDown'){
        e.preventDefault();
        const next = (highlightedIndex + 1) % suggestionMatches.length;
        setActiveSuggestion(next);
      } else if(e.key === 'ArrowUp'){
        e.preventDefault();
        const prev = (highlightedIndex - 1 + suggestionMatches.length) % suggestionMatches.length;
        setActiveSuggestion(prev);
      } else if(e.key === 'Enter'){
        e.preventDefault();
        selectSuggestion(highlightedIndex >= 0 ? highlightedIndex : 0);
      } else if(e.key === 'Escape'){
        clearSuggestions();
      }
    }

    if(searchInput){
      searchInput.addEventListener('input', handleSearchInput);
      searchInput.addEventListener('keydown', handleSearchKeydown);
      searchInput.addEventListener('blur', function(){ setTimeout(clearSuggestions, 120); });
    }

    function displayResult(officer){
      if(!officer){ resultBox.innerHTML = ''; return; }
      resultBox.innerHTML = `
        <div class="card directory-result">
          <div class="directory-meta">
            <p style="margin:0"><strong>${officer[1] || ''}</strong></p>
            <p style="margin:0">${officer[2] || ''}</p>
            <p style="margin:0; opacity:0.75">${officer[0] || ''}</p>
          </div>
          <div class="panel-actions" style="justify-content:flex-start;">
            <button class="btn secondary" id="mark-att-btn">Mark Attendance</button>
          </div>
        </div>`;
      // allow admin to mark status manually
      const markBtn = document.getElementById('mark-att-btn');
      if(markBtn){
        markBtn.onclick = function(){
          // open modal to choose status and record
          showModal({
            title: 'Manual Attendance',
            bodyHtml: `<div style="display:flex;flex-direction:column;gap:8px">
              <div><strong>${officer[1] || ''}</strong><div style="opacity:.8">${officer[0] || ''}</div></div>
              <label style="font-weight:700">Status</label>
              <select id="manual-att-status" class="input-field">
                <option value="Present">Present</option>
                <option value="Late">Late</option>
                <option value="Absent">Absent</option>
                <option value="Excused">Excused</option>
              </select>
            </div>`,
            footerHtml: `<button class="btn" id="save-manual-att">Save</button> <button class="btn secondary" id="cancel-manual-att">Cancel</button>`
          });
          setTimeout(function(){
            document.getElementById('cancel-manual-att').onclick = closeModal;
            document.getElementById('save-manual-att').onclick = function(){
              const status = document.getElementById('manual-att-status').value;
              closeModal();
              // call backend to record manual attendance (supply idCode and status)
              if(window.google && google.script){
                google.script.run.withSuccessHandler(function(res){
                  if(res && res.success) {
                    alert(`Recorded ${officer[0]} as ${status}`);
                  } else {
                    alert(res.message || 'Failed to record.');
                  }
                }).withFailureHandler(function(err){ console.error(err); alert('Connection error.'); }).recordManualAttendance(officer[0], status);
              } else {
                alert('(Local) Recorded ' + officer[0] + ' as ' + status);
              }
            };
          }, 40);
        };
      }
    }

    // ---------------- Feedback & logs ----------------
    function loadFeedback(){
      feedbackContainer.innerHTML = 'Loading...';
      if(!window.google || !google.script){
        feedbackContainer.innerHTML = '<p>Local preview: backend not available.</p>'; return;
      }
      google.script.run.withSuccessHandler(function(res){
        if(!res || !res.success){ feedbackContainer.innerHTML = '<p>No feedback or error.</p>'; return; }
        const rows = res.data || [];
        if(!rows.length){ feedbackContainer.innerHTML = '<p>No feedback found.</p>'; return; }
        let html = `<table class="styled-table"><thead><tr><th>Timestamp</th><th>Name</th><th>ID</th><th>Message</th></tr></thead><tbody>`;
        rows.forEach(function(r){ html += `<tr><td>${r.timestamp||''}</td><td>${r.name||''}</td><td>${r.idCode||''}</td><td>${r.message||''}</td></tr>`; });
        html += `</tbody></table>`;
        feedbackContainer.innerHTML = html;
      }).withFailureHandler(function(err){
        console.error('getFeedback failed', err);
        feedbackContainer.innerHTML = '<p>Unable to load feedback at this time.</p>';
      }).getFeedback();
    }

    function loadAccessLogs(){
      logsContainer.innerHTML = 'Loading...';
      if(!window.google || !google.script){ logsContainer.innerHTML = '<p>Local preview: backend not available.</p>'; return; }
      google.script.run.withSuccessHandler(function(res){
        if(!res || !res.success){ logsContainer.innerHTML = '<p>No logs or error.</p>'; return; }
        const rows = res.data || [];
        if(!rows.length){ logsContainer.innerHTML = '<p>No access logs found.</p>'; return; }
        logsContainer.innerHTML = rows.map(function(r){ return `<div class="card" style="margin-bottom:8px"><strong>${r.name}</strong><div style="opacity:.8">${r.idCode} • ${r.timestamp}</div></div>`; }).join('');
      }).withFailureHandler(function(err){
        console.error('getAccessLogs failed', err);
        logsContainer.innerHTML = '<p>Unable to load access logs right now.</p>';
      }).getAccessLogs();
    }

    // ---------------- Profile ----------------
    function loadUserProfile(){
      profileContainer.innerHTML = 'Loading...';
      if(!appState.currentUser || !appState.currentUser.idCode){ profileContainer.innerHTML = '<p>No user info</p>'; return; }
      if(!window.google || !google.script){ profileContainer.innerHTML = '<p>Local preview: backend not available.</p>'; return; }
      google.script.run.withSuccessHandler(function(res){
        if(!res || !res.success){ profileContainer.innerHTML = '<p>Could not load profile.</p>'; return; }
        const p = res.data || {};
        const profileImage = escapeAttr(safeImageUrl(p.ProfilePictureURL || p.ProfilePicture || '', 'https://via.placeholder.com/150'));
        profileContainer.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center">
            <img src="${profileImage}" class="avatar" style="width:110px;height:110px">
            <div>
              <h3 style="margin:0">${p['Full name']||p.FullName||p.Username||appState.currentUser.name||''}</h3>
              <p style="margin:6px 0 0 0">${p.Position || p.position || ''} • ${p.Role || p.role || ''}</p>
              <p style="margin:6px 0 0 0;opacity:.8">ID: ${p['ID Code'] || p.IDCode || p.idCode || appState.currentUser.idCode || ''}</p>
            </div>
          </div>

          <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="card"><strong>Email</strong><div style="margin-top:6px">${p['Email Address (B)'] || p.Email || ''}</div></div>
            <div class="card"><strong>Birthday</strong><div style="margin-top:6px">${p['Date of Birth (E)']||p.DateOfBirth||''}</div></div>

            <div class="card"><strong>Age</strong><div style="margin-top:6px">${p['Age (F)']||p.Age||''}</div></div>
            <div class="card"><strong>Gender / Pronouns</strong><div style="margin-top:6px">${p['Sex/Gender (G)']||p['Pronouns (H)']||''}</div></div>

            <div class="card"><strong>Contact Number</strong><div style="margin-top:6px">${p['Contact Number (J)']||p.Contact||''}</div></div>
            <div class="card"><strong>Nationality</strong><div style="margin-top:6px">${p['Nationality (L)']||p.Nationality||''}</div></div>
          </div>

          <div style="margin-top:12px" class="card"><strong>About</strong><div style="margin-top:6px">${p.Bio || p.BioText || ''}</div></div>
        `;
      }).withFailureHandler(function(err){
        console.error('getUserProfile failed', err);
        profileContainer.innerHTML = '<p>Could not load profile.</p>';
      }).getUserProfile(appState.currentUser.idCode);
    }

    // ---------------- Announcements ----------------
    function loadAnnouncements(){
      annList.innerHTML = 'Loading...';
      if(!window.google || !google.script){ annList.innerHTML = '<p>Local preview: backend not available.</p>'; return; }
      google.script.run.withSuccessHandler(function(res){
        if(!res || !res.success){ annList.innerHTML = '<p>Could not load announcements.</p>'; return; }
        appState.announcements = res.data || [];
        renderAnnouncements();
      }).withFailureHandler(function(err){
        console.error('getAnnouncements failed', err);
        annList.innerHTML = '<p>Could not load announcements.</p>';
      }).getAnnouncements();
    }

    function renderAnnouncements(){
      annList.innerHTML = '';
      const uId = appState.currentUser && appState.currentUser.idCode;
      appState.unreadCount = 0;
      (appState.announcements || []).forEach(function(a){
        if(a.unread && uId && a.unread[uId]) appState.unreadCount++;
      });
      annBadge.innerHTML = appState.unreadCount ? `<span>${appState.unreadCount} new</span>` : '';

      if(!appState.announcements.length){ annList.innerHTML = '<p>No announcements.</p>'; return; }

      appState.announcements.forEach(function(a){
        const isForMe = !a.recipients || a.recipients.length===0 || (appState.currentUser && a.recipients.includes(appState.currentUser.idCode)) || (a.recipients && a.recipients.includes('all'));
        const el = document.createElement('div');
        el.className = 'card';
        el.style.marginBottom = '8px';
        el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${a.title}</strong><div style="font-size:0.9rem;opacity:0.85">${a.timestamp || ''}</div></div>
          <div><small style="opacity:0.9">${isForMe ? 'To you' : 'Group'}</small></div>
        </div>
        <p style="margin:8px 0">${(a.body||'').slice(0,220)}${(a.body||'').length>220 ? '...' : ''}</p>
        <div style="display:flex;gap:8px"><button class="btn secondary" data-id="${a.id}" data-read="${a.unread && appState.currentUser && a.unread[appState.currentUser.idCode] ? '0' : '1'}">Mark Read</button><button class="btn" data-view="${a.id}">View</button></div>`;
        annList.appendChild(el);

        el.querySelector('[data-view]').onclick = function(){ viewAnnouncement(a); };
        el.querySelector('[data-id]').onclick = function(ev){
          const id = ev.currentTarget.dataset.id;
          markAnnouncementRead(id);
        };
      });
    }

    function viewAnnouncement(a){
      showModal({
        title: a.title,
        bodyHtml: `<div style="max-height:60vh;overflow:auto"><p style="text-align:justify">${a.body}</p><p style="margin-top:10px"><em>Sent by: ${a.authorName || ''}</em></p></div>`,
        footerHtml: `<button class="btn secondary" id="close-ann-modal">Close</button>`
      });
      setTimeout(function(){ const b = document.getElementById('close-ann-modal'); if(b) b.onclick = closeModal; }, 40);
      if(a.unread && appState.currentUser && a.unread[appState.currentUser.idCode]) markAnnouncementRead(a.id);
    }

    function markAnnouncementRead(id){
      if(!window.google || !google.script){ loadAnnouncements(); return; }
      google.script.run.withSuccessHandler(function(){ loadAnnouncements(); }).withFailureHandler(function(err){ console.error('markAnnouncementRead failed', err); }).markAnnouncementRead(appState.currentUser.idCode, id);
    }

    // create announcement (only Admin/Auditor/Head)
    if(createAnnBtn){
      createAnnBtn.onclick = function(){
      const role = appState.currentUser && appState.currentUser.role;
      if(!['Admin','Auditor','Head'].includes(role)){ alert('Only Admins, Auditors, Heads can create announcements.'); return; }
      showModal({
        title: 'Create Announcement',
        bodyHtml: `<div style="display:flex;flex-direction:column;gap:8px">
          <input id="ann-title" class="input-field" placeholder="Title">
          <input id="ann-subject" class="input-field" placeholder="Subject (optional)">
          <textarea id="ann-body" class="input-field" placeholder="Body"></textarea>
          <input id="ann-recipients" class="input-field" placeholder="Recipients (comma-separated IDs or 'all' or committee code)">
          <div style="font-size:0.86rem;color:rgba(0,0,0,0.7)">You can enter: <code>all</code>, <code>heads</code>, committee codes (e.g. <code>YSPTIR</code>), or specific ID codes separated by commas.</div>
        </div>`,
        footerHtml: `<button class="btn" id="ann-send">Send</button><button class="btn secondary" id="ann-cancel">Cancel</button>`
      });
      setTimeout(function(){
        $('#ann-cancel').onclick = closeModal;
        $('#ann-send').onclick = function(){
          const title = $('#ann-title').value.trim();
          const body = $('#ann-body').value.trim();
          const recipientsRaw = $('#ann-recipients').value.trim();
          if(!title || !body){ alert('Title and body required'); return; }
          const recipients = recipientsRaw ? recipientsRaw.split(',').map(function(s){ return s.trim(); }).filter(Boolean) : ['all'];
          const payload = {
            authorId: appState.currentUser.idCode,
            authorName: appState.currentUser.name,
            title,
            body,
            recipients
          };
          if(!window.google || !google.script){
            alert('Local: announcement created (not persisted).');
            closeModal();
            loadAnnouncements();
            return;
          }
          google.script.run.withSuccessHandler(function(res){
            if(res && res.success){
              alert('Announcement created and emails queued.');
              closeModal();
              loadAnnouncements();
            } else {
              alert(res.message || 'Failed to create announcement.');
            }
          }).withFailureHandler(function(err){
            console.error(err);
            alert('Failed to create announcement (server error).');
          }).createAnnouncement(payload);
        };
      }, 40);
      };
    }

    // load unread badge
    function loadUnreadAnnouncements(){
      if(!window.google || !google.script) return;
      google.script.run.withSuccessHandler(function(res){
        if(!res || !res.success) return;
        appState.announcements = res.data || [];
        let c = 0; const id = appState.currentUser && appState.currentUser.idCode;
        (appState.announcements||[]).forEach(function(a){ if(a.unread && id && a.unread[id]) c++; });
        appState.unreadCount = c;
        annBadge.innerHTML = c ? `<span>${c} new</span>` : '';
      }).withFailureHandler(function(err){
        console.warn('getAnnouncements (badge) failed', err);
      }).getAnnouncements();
    }

    // ---------------- Attendance transparency ----------------
    function loadAttendanceTransparency(){
      attendanceTable.innerHTML = 'Loading...';
      if(!window.google || !google.script){ attendanceTable.innerHTML = '<p>Local preview: backend not available.</p>'; return; }
      google.script.run.withSuccessHandler(function(res){
        if(!res || !res.success){ attendanceTable.innerHTML = '<p>Could not load attendance data.</p>'; return; }
        const rows = res.data || [];
        if(!rows.length){ attendanceTable.innerHTML = '<p>No attendance records.</p>'; return; }
        let html = `<table class="styled-table"><thead><tr><th>Date</th><th>Event</th><th>Time In</th><th>Time Out</th></tr></thead><tbody>`;
        rows.forEach(function(r){
          html += `<tr><td>${r.date||''}</td><td>${r.event||''}</td><td>${r.timeIn||''}</td><td>${r.timeOut||''}</td></tr>`;
        });
        html += '</tbody></table>';
        attendanceTable.innerHTML = html;
      }).withFailureHandler(function(err){
        console.error('getAttendanceTransparencyForUser failed', err);
        attendanceTable.innerHTML = '<p>Could not load attendance data.</p>';
      }).getAttendanceTransparencyForUser(appState.currentUser.idCode);
    }

    // ---------------- My QR ----------------
    function showMyQr(){
      const id = appState.currentUser && appState.currentUser.idCode;
      if(!id){ alert('No ID code'); return; }
      showModal({
        title: 'My QR Code',
        bodyHtml: `<div style="text-align:center"><div id="qr-holder" style="display:inline-block;position:relative"></div><p style="margin-top:10px">${appState.currentUser.name || ''}<br><small style="opacity:.8">${appState.currentUser.position || ''} • ${id}</small></p></div>`,
        footerHtml: `<button class="btn secondary" id="close-qr-btn">Close</button>`
      });
      setTimeout(function(){
        const qrHolder = document.getElementById('qr-holder');
        try {
          qrHolder.innerHTML = '';
          new QRCode(qrHolder, { text: id, width:220, height:220, correctLevel: QRCode.CorrectLevel.H });
          // overlay logo - place by absolute positioning
          const logo = document.createElement('img');
          logo.src = 'https://i.imgur.com/J4wddTW.png';
          logo.style.position = 'absolute';
          logo.style.width = '48px';
          logo.style.height = '48px';
          logo.style.left = '50%';
          logo.style.top = '50%';
          logo.style.transform = 'translate(-50%,-50%)';
          logo.style.borderRadius = '8px';
          logo.style.boxShadow = '0 6px 18px rgba(0,0,0,0.12)';
          qrHolder.appendChild(logo);
        } catch(e){ console.warn('QR error', e); }
        const closeBtn = document.getElementById('close-qr-btn'); if(closeBtn) closeBtn.onclick = closeModal;
      }, 80);
    }

    // ---------------- Initial wiring ----------------
    loginBtn.addEventListener('click', handleLogin);
    guestLoginBtn.addEventListener('click', handleGuestLogin);
    $$('.back-btn').forEach(function(btn){
      btn.addEventListener('click', function(){
        const t = btn.dataset.target;
        if(!t) return;
        if(t === 'login-panel'){
          switchPanels(t);
          if(usernameInput){ setTimeout(function(){ usernameInput.focus(); }, 120); }
          return;
        }
        switchPanels(t);
      });
    });
    [usernameInput, passwordInput].forEach(function(inp){
      inp.addEventListener('keydown', function(e){ if(e.key === 'Enter') handleLogin(); });
    });

    // initial panel state
    panels.forEach(function(p){ if(p.id !== 'login-panel'){ p.classList.add('hidden'); p.style.display = 'none'; }});
    loginPanel.classList.remove('hidden'); loginPanel.classList.add('active'); loginPanel.style.display = 'flex';

    // expose for debug
    window.__YSP = {
      switchPanels, loadHomepage, loadAnnouncements, loadFeedback, loadAccessLogs, loadUserProfile, showMyQr
    };

    // If server has session info, optionally fetch (server-side session login)
    if(window.google && google.script && typeof google.script.run.getSession === 'function'){
      google.script.run.withSuccessHandler(function(sess){
        if(sess && sess.user){
          appState.currentUser = sess.user;
          populateAfterLogin();
        }
      }).withFailureHandler(function(err){ console.warn('getSession unavailable', err); }).getSession();
    }

    console.log('✅ YSP Web App Initialized OK');
    });
  })();
  </script>
</body>
</html>
