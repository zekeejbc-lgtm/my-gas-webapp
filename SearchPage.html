<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YSP Tagum — Member App</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="icon" href="https://i.imgur.com/J4wddTW.png" />
  <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #f6421f;
      --secondary: #ee8724;
      --tertiary: #fbcb29;
      --bg-gradient: linear-gradient(135deg, var(--primary), var(--secondary), var(--tertiary));
      --text-dark: #1c1c1c;
      --text-muted: rgba(0, 0, 0, 0.65);
      --surface: rgba(255, 255, 255, 0.97);
      --border: rgba(255, 255, 255, 0.55);
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.16);
      --shadow-light: 0 8px 20px rgba(0, 0, 0, 0.08);
      --radius-lg: 22px;
      --radius-md: 16px;
      --radius-sm: 10px;
      --space-xs: clamp(6px, 1vh, 10px);
      --space-sm: clamp(10px, 1.6vh, 16px);
      --space-md: clamp(16px, 2.8vh, 24px);
      --space-lg: clamp(24px, 3.5vh, 40px);
      --space-xl: clamp(32px, 4.5vh, 56px);
      --success: #2ecc71;
      --danger: #ff3b30;
      --warn: #f1c40f;
      font-size: 16px;
    }

    *, *::before, *::after { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      width: 100%;
    }

    body {
      font-family: "Roboto", sans-serif;
      background: var(--bg-gradient);
      background-size: 300% 300%;
      animation: gradientShift 18s linear infinite;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(18px, 6vw, 48px) clamp(12px, 4vw, 40px);
      color: var(--text-dark);
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    @media (prefers-reduced-motion: reduce) {
      body { animation: none; }
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: linear-gradient(160deg, rgba(255,255,255,0.16), rgba(255,255,255,0.08));
      pointer-events: none;
      z-index: 0;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    #app {
      position: relative;
      z-index: 1;
      width: min(100%, 1080px);
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
    }

    .panel {
      display: none;
      flex-direction: column;
      gap: var(--space-md);
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: clamp(18px, 4vw, 36px);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      backdrop-filter: blur(8px);
      max-height: calc(100dvh - clamp(120px, 14vh, 220px));
      overflow: hidden auto;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .panel.active {
      display: flex !important;
      opacity: 1;
      transform: translateY(0);
    }

    .panel.hidden {
      display: none !important;
      opacity: 0;
      transform: translateY(14px) scale(0.99);
      pointer-events: none;
    }

    .panel-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-xs);
      text-align: center;
    }

    .panel-header h1,
    .panel-header h2 {
      font-family: "Lexend", sans-serif;
      margin: 0;
      color: var(--primary);
      letter-spacing: 0.02em;
    }

    .panel-header h1 { font-size: clamp(1.5rem, 2.4vw, 2.1rem); }
    .panel-header h2 { font-size: clamp(1.1rem, 2vw, 1.4rem); }

    .panel-header p { margin: 0; color: var(--text-muted); }

    .panel-body {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      width: 100%;
    }

    .logo {
      width: clamp(68px, 10vw, 90px);
      height: clamp(68px, 10vw, 90px);
      object-fit: contain;
      border-radius: 50%;
      background: rgba(255,255,255,0.6);
      padding: 6px;
      box-shadow: var(--shadow-light);
    }

    .form-stack { display: flex; flex-direction: column; gap: var(--space-sm); }
    label { font-weight: 500; color: var(--text-muted); }

    input[type="text"],
    input[type="password"],
    input[type="email"],
    textarea,
    select {
      width: 100%;
      padding: 12px 14px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(0,0,0,0.03);
      font: inherit;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: 3px solid rgba(246,66,31,0.18);
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(246,66,31,0.12);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 44px;
      padding: 0 18px;
      border-radius: var(--radius-md);
      border: none;
      font: 600 0.95rem "Roboto", sans-serif;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.2s ease;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      box-shadow: var(--shadow-light);
    }

    .btn-secondary {
      background: rgba(0,0,0,0.04);
      color: var(--text-dark);
      border: 1px solid rgba(0,0,0,0.08);
    }

    .btn-danger { background: var(--danger); color: #fff; }

    .btn:focus-visible {
      outline: 3px solid rgba(251,203,41,0.5);
      outline-offset: 2px;
    }

    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: scale(0.98); }

    .icon-button {
      border: none;
      background: rgba(0,0,0,0.05);
      border-radius: 50%;
      width: 46px;
      height: 46px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      transition: background 0.2s ease;
    }

    .icon-button svg { width: 22px; height: 22px; fill: none; stroke: currentColor; }
    .icon-button:hover { background: rgba(246,66,31,0.12); }
    .icon-button.pulse::after {
      content: "";
      position: absolute;
      inset: -4px;
      border-radius: 50%;
      border: 2px solid rgba(246,66,31,0.45);
      animation: pulse 0.45s ease;
    }

    @keyframes pulse {
      from { opacity: 0.8; transform: scale(0.88); }
      to { opacity: 0; transform: scale(1.3); }
    }

    .panel-actions {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
    }

    .tile-grid {
      display: grid;
      gap: var(--space-sm);
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .tile {
      background: rgba(255,255,255,0.85);
      border-radius: var(--radius-md);
      padding: var(--space-sm);
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: var(--shadow-light);
      border: 1px solid rgba(0,0,0,0.05);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .tile:hover { transform: translateY(-3px); box-shadow: 0 12px 22px rgba(0,0,0,0.12); }
    .tile:focus-visible { outline: 3px solid rgba(251,203,41,0.55); }
    .tile-title { font-weight: 600; font-family: "Lexend", sans-serif; color: var(--primary); }
    .tile-desc { font-size: 0.85rem; color: var(--text-muted); }

    .back-btn { align-self: flex-start; }

    .card-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: var(--space-sm);
    }

    .card {
      background: rgba(255,255,255,0.88);
      border-radius: var(--radius-md);
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: var(--shadow-light);
      padding: var(--space-sm);
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .card h3 { margin: 0; font-family: "Lexend", sans-serif; color: var(--primary); }
    .card p { margin: 0; color: var(--text-muted); font-size: 0.92rem; }

    .ratio-box {
      position: relative;
      width: 100%;
      padding-top: 56.25%;
      border-radius: var(--radius-md);
      overflow: hidden;
      background: rgba(0,0,0,0.08);
    }

    .ratio-box img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    ul.suggestion-list {
      list-style: none;
      margin: 0;
      padding: 0;
      border-radius: var(--radius-md);
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.95);
      box-shadow: var(--shadow-light);
      overflow: hidden;
    }

    ul.suggestion-list li {
      padding: 10px 14px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    ul.suggestion-list li:hover,
    ul.suggestion-list li:focus-visible {
      background: rgba(246,66,31,0.12);
      outline: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-light);
    }

    thead { background: rgba(246,66,31,0.12); }
    th, td { padding: 12px 14px; text-align: left; font-size: 0.92rem; }
    tbody tr:nth-child(even) { background: rgba(0,0,0,0.02); }

    .toast-container {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 999;
      pointer-events: none;
    }

    .toast {
      background: rgba(28,28,28,0.92);
      color: #fff;
      padding: 12px 18px;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow);
      animation: slideUp 0.3s ease;
      pointer-events: auto;
      max-width: 320px;
      font-size: 0.92rem;
    }

    .toast.fade-out {
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translate(-50%, 12px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.82rem;
      font-weight: 600;
      background: rgba(46,204,113,0.15);
      color: #187741;
    }

    .status-chip.danger { background: rgba(255,59,48,0.16); color: #a01010; }
    .status-chip.warn { background: rgba(251,203,41,0.2); color: #8c5f00; }

    .flex-row { display: flex; gap: var(--space-sm); flex-wrap: wrap; align-items: center; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }

    .link { color: var(--primary); text-decoration: underline; cursor: pointer; }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: var(--space-sm);
    }

    .stat-card {
      background: rgba(255,255,255,0.9);
      border-radius: var(--radius-md);
      padding: var(--space-sm);
      display: flex;
      flex-direction: column;
      gap: 4px;
      text-align: center;
      box-shadow: var(--shadow-light);
    }

    .stat-card span { font-size: 0.85rem; color: var(--text-muted); }
    .stat-card strong { font-size: 1.4rem; color: var(--primary); }

    .list-empty {
      text-align: center;
      padding: var(--space-md);
      color: var(--text-muted);
      border-radius: var(--radius-md);
      background: rgba(0,0,0,0.02);
    }

    .modal-root { position: relative; z-index: 1000; }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(17,17,17,0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(16px, 4vw, 40px);
      animation: fadeIn 0.2s ease;
    }

    .modal {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      width: min(520px, 100%);
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transform: translateY(0);
      animation: modalIn 0.25s ease;
    }

    .modal__panel { display: flex; flex-direction: column; }
    .modal__header, .modal__footer { padding: var(--space-sm) var(--space-md); }
    .modal__body { padding: var(--space-sm) var(--space-md); overflow: auto; }
    .modal__title { margin: 0; font-family: "Lexend", sans-serif; color: var(--primary); }
    .modal__close { background: none; border: none; font-size: 1.8rem; line-height: 1; cursor: pointer; }

    @keyframes modalIn { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    @media (max-width: 768px) {
      body { padding: 24px 14px; }
      .panel { padding: clamp(16px, 5vw, 28px); max-height: calc(100dvh - 120px); }
      .tile-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
    }

    @media (max-width: 480px) {
      .panel { padding: 18px; }
      .panel-header h1 { font-size: 1.35rem; }
      .panel-header h2 { font-size: 1.05rem; }
      .card-list { grid-template-columns: 1fr; }
      .tile-grid { grid-template-columns: 1fr; }
      .flex-row { flex-direction: column; align-items: stretch; }
      .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <div id="app">
    <section id="login-panel" class="panel active" aria-labelledby="login-title">
      <header class="panel-header">
        <img src="https://i.imgur.com/J4wddTW.png" alt="YSP Tagum Logo" class="logo" />
        <h1 id="login-title">YSP Tagum Chapter</h1>
        <p>Welcome! Please log in with your member credentials or continue as a guest.</p>
      </header>
      <div class="panel-body">
        <div class="form-stack">
          <label for="username">Member ID or Email</label>
          <input id="username" type="text" autocomplete="username" placeholder="Enter your ID or email" />
        </div>
        <div class="form-stack">
          <div class="flex-between">
            <label for="password">Password</label>
            <button id="eye-toggle" type="button" class="icon-button" aria-label="Toggle password visibility">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"></path>
                <circle cx="12" cy="12" r="3"></circle>
                <line x1="4" y1="4" x2="20" y2="20" stroke-width="2"></line>
              </svg>
            </button>
          </div>
          <input id="password" type="password" autocomplete="current-password" placeholder="Enter your password" />
        </div>
        <div class="panel-actions">
          <button id="login-btn" class="btn btn-primary" type="button">Log In</button>
          <button id="guest-login-btn" class="btn btn-secondary" type="button">Log In as Guest</button>
        </div>
        <p id="login-status" class="text-muted" role="status" aria-live="polite"></p>
      </div>
    </section>

    <section id="main-menu-panel" class="panel" aria-labelledby="dashboard-title">
      <header class="panel-header">
        <h1 id="dashboard-title">Main Menu</h1>
        <p id="dashboard-subtitle">Choose a module to continue.</p>
      </header>
      <div class="panel-body">
        <div id="dashboard-tiles" class="tile-grid" role="list"></div>
      </div>
    </section>

    <section id="homepage-panel" class="panel" aria-labelledby="homepage-title">
      <button class="btn btn-secondary back-btn" type="button" data-target="login-panel">Back to Login</button>
      <header class="panel-header">
        <h1 id="homepage-title">YSP Tagum Homepage</h1>
      </header>
      <div class="panel-body">
        <article class="card">
          <h3>About</h3>
          <p id="home-about">Loading...</p>
        </article>
        <div class="card-list">
          <article class="card">
            <h3>Mission</h3>
            <p id="home-mission">Loading...</p>
          </article>
          <article class="card">
            <h3>Vision</h3>
            <p id="home-vision">Loading...</p>
          </article>
          <article class="card">
            <h3>Objectives</h3>
            <p id="home-objectives">Loading...</p>
          </article>
        </div>
        <section class="card">
          <h3>Organizational Chart</h3>
          <div class="ratio-box">
            <img id="home-org-chart" src="https://placehold.co/800x450?text=Organizational+Chart" alt="YSP Organizational Chart" />
          </div>
        </section>
        <section>
          <h2>Projects</h2>
          <div id="projects-grid" class="card-list"></div>
          <div id="projects-empty" class="list-empty" hidden>No projects available yet.</div>
        </section>
        <section class="card-list">
          <article class="card" id="contact-report-card">
            <h3>Report Issues</h3>
            <p>If you experience any issue, reach out through Facebook or Email.</p>
            <div class="panel-actions">
              <button id="contact-fb" class="btn btn-primary" type="button">Open Facebook</button>
              <button id="contact-email" class="btn btn-secondary" type="button">Send Email</button>
            </div>
          </article>
          <article class="card">
            <h3>Web App Developer</h3>
            <p>The YSP Tagum digital team maintains this platform. Please send constructive feedback using the in-app forms.</p>
          </article>
        </section>
      </div>
    </section>

    <section id="profile-panel" class="panel" aria-labelledby="profile-title">
      <button class="btn btn-secondary back-btn" type="button" data-target="main-menu-panel">Back</button>
      <header class="panel-header">
        <h1 id="profile-title">My Profile</h1>
      </header>
      <div class="panel-body">
        <div id="profile-card" class="card">
          <h3 id="profile-name">Guest Member</h3>
          <p id="profile-role" class="text-muted">Role</p>
          <p><span class="text-muted">Email:</span> <span id="profile-email">guest@example.com</span></p>
          <p><span class="text-muted">Member ID:</span> <span id="profile-id">N/A</span></p>
          <div class="ratio-box" aria-hidden="true">
            <div id="qrid"></div>
          </div>
          <button id="btn-download-qr" type="button" class="btn btn-secondary">Download QR</button>
        </div>
      </div>
    </section>

    <section id="qr-attendance-panel" class="panel" aria-labelledby="qr-attendance-title">
      <button class="btn btn-secondary back-btn" type="button" data-target="main-menu-panel">Back</button>
      <header class="panel-header">
        <h1 id="qr-attendance-title">QR Attendance</h1>
      </header>
      <div class="panel-body">
        <div class="form-stack">
          <label for="event-select">Event</label>
          <select id="event-select">
            <option value="">Select an event</option>
          </select>
        </div>
        <div class="panel-actions">
          <button id="start-scan" class="btn btn-primary" type="button">Start Scanner</button>
          <button id="stop-scan" class="btn btn-secondary" type="button">Stop Scanner</button>
        </div>
        <div class="form-stack">
          <label for="scan-file">Upload QR Image (Fallback)</label>
          <input id="scan-file" type="file" accept="image/*" />
          <button id="scan-file-btn" class="btn btn-secondary" type="button">Scan Uploaded QR</button>
        </div>
        <div id="scanner" class="card" role="region" aria-live="polite"></div>
        <div id="scan-fallback-target" style="display:none;"></div>
        <div id="scan-output" class="card" aria-live="polite">
          <h3>Scan Log</h3>
          <div id="scan-log"></div>
        </div>
      </div>
    </section>

    <section id="manual-attendance-panel" class="panel" aria-labelledby="manual-attendance-title">
      <button class="btn btn-secondary back-btn" type="button" data-target="main-menu-panel">Back</button>
      <header class="panel-header">
        <h1 id="manual-attendance-title">Manual Attendance</h1>
      </header>
      <div class="panel-body">
        <div class="form-stack">
          <label for="manual-event">Event</label>
          <select id="manual-event">
            <option value="">Select an event</option>
          </select>
        </div>
        <div class="form-stack">
          <label for="manual-member">Member</label>
          <input id="manual-member" type="text" placeholder="Search member" autocomplete="off" />
          <ul id="manual-suggestions" class="suggestion-list" hidden></ul>
        </div>
        <div class="panel-actions">
          <button id="manual-time-in" class="btn btn-primary" type="button">Time In</button>
          <button id="manual-time-out" class="btn btn-secondary" type="button">Time Out</button>
        </div>
        <div id="manual-status" class="text-muted" role="status" aria-live="polite"></div>
      </div>
    </section>

    <section id="attendance-dashboard-panel" class="panel" aria-labelledby="attendance-dashboard-title">
      <button class="btn btn-secondary back-btn" type="button" data-target="main-menu-panel">Back</button>
      <header class="panel-header">
        <h1 id="attendance-dashboard-title">Attendance Dashboard</h1>
      </header>
      <div class="panel-body">
        <div class="stat-grid" id="kpi-stats"></div>
        <canvas id="kpi-canvas" height="280" aria-label="Attendance KPI chart" role="img"></canvas>
      </div>
    </section>

    <section id="attendance-trans-panel" class="panel" aria-labelledby="attendance-trans-title">
      <button class="btn btn-secondary back-btn" type="button" data-target="main-menu-panel">Back</button>
      <header class="panel-header">
        <h1 id="attendance-trans-title">My Attendance Records</h1>
      </header>
      <div class="panel-body">
        <div id="attendance-table" aria-live="polite"></div>
      </div>
    </section>

    <section id="manage-events-panel" class="panel" aria-labelledby="manage-events-title">
      <button class="btn btn-secondary back-btn" type="button" data-target="main-menu-panel">Back</button>
      <header class="panel-header">
        <h1 id="manage-events-title">Manage Events</h1>
      </header>
      <div class="panel-body">
        <div class="panel-actions">
          <button id="btn-create-event" class="btn btn-primary" type="button">Create Event</button>
        </div>
        <div id="events-table" aria-live="polite"></div>
      </div>
    </section>

    <section id="directory-panel" class="panel" aria-labelledby="directory-title">
      <button class="btn btn-secondary back-btn" type="button" data-target="main-menu-panel">Back</button>
      <header class="panel-header">
        <h1 id="directory-title">Officer Directory</h1>
      </header>
      <div class="panel-body">
        <div class="form-stack">
          <label for="search-input">Search Member</label>
          <input id="search-input" type="text" placeholder="Type name or ID" autocomplete="off" />
          <ul id="suggestions-list" class="suggestion-list" hidden></ul>
        </div>
        <div id="officer-profile" class="directory-result"></div>
      </div>
    </section>
    <section id="announcements-panel" class="panel" aria-labelledby="announcements-title">
      <button class="btn btn-secondary back-btn" type="button" data-target="main-menu-panel">Back</button>
      <header class="panel-header">
        <h1 id="announcements-title">Announcements</h1>
      </header>
      <div class="panel-body">
        <div class="panel-actions">
          <button id="btn-create-announcement" class="btn btn-primary" type="button">Create Announcement</button>
        </div>
        <div id="announcements-list" class="card-list"></div>
      </div>
    </section>

    <section id="submit-feedback-panel" class="panel" aria-labelledby="submit-feedback-title">
      <button class="btn btn-secondary back-btn" type="button" data-target="main-menu-panel">Back</button>
      <header class="panel-header">
        <h1 id="submit-feedback-title">Submit Feedback</h1>
      </header>
      <div class="panel-body">
        <div class="form-stack">
          <label for="feedback-text">Your Feedback</label>
          <textarea id="feedback-text" rows="5" placeholder="Share your thoughts"></textarea>
        </div>
        <div class="panel-actions">
          <button id="btn-send-feedback" class="btn btn-primary" type="button">Send Feedback</button>
        </div>
        <div id="feedback-status" class="text-muted" role="status" aria-live="polite"></div>
      </div>
    </section>

    <section id="view-feedback-panel" class="panel" aria-labelledby="view-feedback-title">
      <button class="btn btn-secondary back-btn" type="button" data-target="main-menu-panel">Back</button>
      <header class="panel-header">
        <h1 id="view-feedback-title">Feedback Inbox</h1>
      </header>
      <div class="panel-body">
        <div id="feedback-list" class="card-list"></div>
      </div>
    </section>

    <section id="view-logs-panel" class="panel" aria-labelledby="view-logs-title">
      <button class="btn btn-secondary back-btn" type="button" data-target="main-menu-panel">Back</button>
      <header class="panel-header">
        <h1 id="view-logs-title">Access Logs</h1>
      </header>
      <div class="panel-body">
        <div id="logs-table"></div>
      </div>
    </section>
  </div>

  <div id="modal-root" hidden></div>
  <div id="toast-container" class="toast-container" role="status" aria-live="polite" aria-atomic="true"></div>

  <?!= include('Shared'); ?>

  <script>
    (function(){
      'use strict';

      if(!window.YSP){ window.YSP = {}; }
      if(typeof YSP.openExternal !== 'function'){
        YSP.openExternal = function(url){
          try {
            var value = String(url || '').trim();
            if(!value){ return; }
            if(!/^https?:\/\//i.test(value)){ value = 'https://' + value; }
            var parsed = new URL(value);
            if(parsed.protocol === 'http:' || parsed.protocol === 'https:'){
              var win = window.open(parsed.toString(), '_blank', 'noopener');
              if(win){ win.opener = null; }
            }
          } catch (err) {
            console.warn('openExternal fallback rejected URL', err);
          }
        };
      }
      if(!YSP.modal || typeof YSP.modal.open !== 'function' || typeof YSP.modal.close !== 'function'){
        YSP.modal = (function(){
          var root = null;
          var lastFocused = null;

          function ensureRoot(){
            if(!root){
              root = document.getElementById('modal-root');
              if(!root){
                root = document.createElement('div');
                root.id = 'modal-root';
                root.hidden = true;
                document.body.appendChild(root);
              }
            }
            return root;
          }

          function close(skipFocusRestore){
            if(!root){ return; }
            root.innerHTML = '';
            root.hidden = true;
            if(!skipFocusRestore && lastFocused && typeof lastFocused.focus === 'function'){
              try { lastFocused.focus(); } catch (err) {}
            }
            lastFocused = null;
            document.removeEventListener('keydown', onEsc, true);
          }

          function onEsc(event){
            if(event && event.key === 'Escape'){
              close(false);
            }
          }

          function open(opts){
            ensureRoot();
            var options = opts || {};
            lastFocused = options.opener || document.activeElement || null;

            var backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop is-open';

            var modal = document.createElement('div');
            modal.className = 'modal is-open';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');

            var panel = document.createElement('div');
            panel.className = 'modal__panel';

            var header = document.createElement('div');
            header.className = 'modal__header';

            var title = document.createElement('h2');
            title.className = 'modal__title';
            title.textContent = options.title || 'Dialog';
            header.appendChild(title);

            var closeBtn = document.createElement('button');
            closeBtn.type = 'button';
            closeBtn.className = 'modal__close';
            closeBtn.setAttribute('aria-label', 'Close dialog');
            closeBtn.innerHTML = '&times;';
            closeBtn.addEventListener('click', function(){ close(false); });
            header.appendChild(closeBtn);

            var body = document.createElement('div');
            body.className = 'modal__body';
            body.innerHTML = options.bodyHtml || '';

            var footer = document.createElement('div');
            footer.className = 'modal__footer';
            footer.innerHTML = options.footerHtml || '<button type="button" data-close="1">Close</button>';

            panel.appendChild(header);
            panel.appendChild(body);
            panel.appendChild(footer);
            modal.appendChild(panel);

            var host = ensureRoot();
            host.innerHTML = '';
            host.appendChild(backdrop);
            host.appendChild(modal);
            host.hidden = false;

            var closers = host.querySelectorAll('[data-close]');
            for(var i = 0; i < closers.length; i++){
              closers[i].addEventListener('click', function(){ close(false); });
            }

            backdrop.addEventListener('click', function(ev){
              if(ev.target === backdrop){ close(false); }
            });

            document.addEventListener('keydown', onEsc, true);

            setTimeout(function(){
              var first = modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
              if(first && typeof first.focus === 'function'){
                first.focus();
              }
            }, 30);
          }

          return { open: open, close: close };
        })();
      }

      var session = null;
      var officerCache = { list: [], map: {} };
      var officerFetched = false;
      var homepageLoaded = false;
      var homepageData = null;
      var kpiChart = null;
      var loginBound = false;
      var directoryBound = false;
      var manualBound = false;
      var hashNavigating = false;
      var html5Qr = null;
      var fallbackQr = null;
      var scannerRunning = false;
      var projectModalOpener = null;

      var mockData = {
        validateLogin: function(u){
          return { success: true, user: { name: u || 'Member User', role: 'Member', email: 'member@example.com', id: 'YSP-0000' } };
        },
        guestLogin: function(name){
          return { success: true, user: { name: name || 'Guest', role: 'Guest', email: 'guest@tagum.ysp', id: 'GUEST', isGuest: true } };
        },
        getHomepageContent: function(){
          return {
            success: true,
            about: 'The Youth and Students for Peace (YSP) Tagum Chapter empowers the youth through service.',
            mission: 'Promote peacebuilding programs and community engagement.',
            vision: 'A united youth community grounded in principles of peace, service, and excellence.',
            objectives: 'Cultivate leadership, strengthen collaboration, and advance sustainable initiatives.',
            orgChartUrl: 'https://placehold.co/1024x576?text=Org+Chart',
            facebookUrl: 'https://www.facebook.com/ysptagum',
            email: 'support@ysptagum.org',
            projects: [
              { title: 'Peace Caravan', description: 'A city-wide caravan promoting youth empowerment.', imageUrl: 'https://placehold.co/640x360?text=Peace+Caravan' },
              { title: 'Tree Planting', description: 'Reforestation drive with local youth leaders.', imageUrl: 'https://placehold.co/640x360?text=Tree+Planting' }
            ]
          };
        },
        officerSuggestions: function(q){
          var items = [
            { id: 'YSP0001', name: 'Juan Dela Cruz', role: 'President', email: 'juan@ysp.org' },
            { id: 'YSP0002', name: 'Maria Santos', role: 'Vice President', email: 'maria@ysp.org' },
            { id: 'YSP0003', name: 'Lee Kim', role: 'Secretary', email: 'lee@ysp.org' }
          ];
          if(!q){ return { success: true, suggestions: items }; }
          var term = String(q).toLowerCase();
          var filtered = items.filter(function(item){
            return item.name.toLowerCase().indexOf(term) !== -1 || item.id.toLowerCase().indexOf(term) !== -1;
          });
          return { success: true, suggestions: filtered };
        },
        getRecordById: function(id){
          return { success: true, record: { id: id, name: 'Sample Officer', role: 'Officer', email: 'officer@ysp.org', avatar: 'https://placehold.co/640x360?text=Officer' } };
        },
        getActiveEvents: function(){
          return { success: true, events: [ { id: 'EVT1', name: 'Monthly Gathering' }, { id: 'EVT2', name: 'Community Outreach' } ] };
        },
        logAttendanceScan: function(code){
          return { success: true, message: 'Attendance recorded for ' + code };
        },
        manualAttendance: function(id, eventId, action){
          return { success: true, message: 'Recorded ' + action + ' for ' + id + ' in event ' + eventId };
        },
        getMyAttendance: function(){
          return { success: true, rows: [
            { date: '2024-05-01', event: 'Peace Rally', timeIn: '08:00', timeOut: '12:00' },
            { date: '2024-05-10', event: 'Workshop', timeIn: '09:00', timeOut: '11:30' }
          ] };
        },
        getAttendanceKPIs: function(){
          return { success: true, stats: { totalEvents: 8, present: 6, absent: 2, late: 1 }, kpi: {
            labels: ['Jan','Feb','Mar','Apr'],
            present: [8,9,7,10],
            absent: [1,0,2,1]
          } };
        },
        listEvents: function(){
          return { success: true, events: [
            { id: 'EVT1', name: 'Peace Summit', date: '2024-06-01', active: true },
            { id: 'EVT2', name: 'Service Project', date: '2024-06-15', active: false }
          ] };
        },
        toggleEventActive: function(id){ return { success: true, message: 'Toggled ' + id }; },
        createEvent: function(){ return { success: true, message: 'Event created.' }; },
        listAnnouncements: function(){
          return { success: true, announcements: [
            { id: 'ANN1', title: 'General Assembly', body: 'Join us this Saturday at the city hall.', createdAt: '2024-05-15', isUnread: true },
            { id: 'ANN2', title: 'Volunteer Drive', body: 'Sign up for our community clean up.', createdAt: '2024-05-10', isUnread: false }
          ] };
        },
        listMyFeedback: function(){
          return { success: true, feedback: [ { id: 'FDB1', message: 'Great event last week!', createdAt: '2024-05-12' } ] };
        },
        listAllFeedback: function(){
          return { success: true, feedback: [
            { id: 'FDB1', name: 'Juan', message: 'Loved the program.', createdAt: '2024-05-12' },
            { id: 'FDB2', name: 'Maria', message: 'More workshops please.', createdAt: '2024-05-14' }
          ] };
        },
        sendFeedback: function(){ return { success: true, message: 'Feedback sent. Thank you!' }; },
        getAccessLogs: function(){
          return { success: true, logs: [
            { timestamp: '2024-05-01 08:00', id: 'YSP0001', name: 'Juan Dela Cruz' },
            { timestamp: '2024-05-01 08:05', id: 'YSP0002', name: 'Maria Santos' }
          ] };
        },
        getSession: function(){ return { success: false }; },
        logout: function(){ return { success: true }; }
      };

      function $(selector, scope){
        return (scope || document).querySelector(selector);
      }
      function $$(selector, scope){
        return Array.prototype.slice.call((scope || document).querySelectorAll(selector));
      }
      function esc(value){
        return String(value == null ? '' : value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }
      function onReady(fn){
        if(document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', fn, { once: true });
        } else {
          fn();
        }
      }
      function openSafe(url){
        if(window.YSP && typeof YSP.openExternal === 'function'){
          YSP.openExternal(url);
        }
      }
      function ensureToastContainer(){
        var el = $('#toast-container');
        if(!el){
          el = document.createElement('div');
          el.id = 'toast-container';
          el.className = 'toast-container';
          document.body.appendChild(el);
        }
        return el;
      }
      function toast(message){
        var container = ensureToastContainer();
        var toastEl = document.createElement('div');
        toastEl.className = 'toast';
        toastEl.textContent = String(message || '');
        container.appendChild(toastEl);
        setTimeout(function(){ toastEl.classList.add('fade-out'); }, 3800);
        setTimeout(function(){ if(toastEl.parentNode){ toastEl.parentNode.removeChild(toastEl); } }, 4200);
      }
      function asPayload(res){
        return res && typeof res === 'object' && res !== null && 'data' in res ? res.data : res;
      }
      function isSuccess(res){
        if(!res || typeof res !== 'object'){ return false; }
        if('success' in res){ return !!res.success; }
        return true;
      }
      function showModal(opts){
        if(!window.YSP || !YSP.modal || typeof YSP.modal.open !== 'function'){
          return;
        }
        var opener = opts && opts.opener ? opts.opener : document.activeElement;
        projectModalOpener = opener;
        YSP.modal.open({
          title: esc(opts && opts.title ? opts.title : 'Dialog'),
          bodyHtml: opts && opts.bodyHtml ? opts.bodyHtml : '',
          footerHtml: opts && opts.footerHtml ? opts.footerHtml : '<button type="button" class="btn btn-secondary" data-close="1">Close</button>'
        });
      }
      function closeModal(options){
        if(window.YSP && YSP.modal && typeof YSP.modal.close === 'function'){
          YSP.modal.close(options && options.skipFocusRestore === true);
        }
      }

      function callServer(name, args, onSuccess, onFailure){
        var runner = window.google && google.script && google.script.run;
        var hasRunner = !!runner;
        var failure = function(err){
          console.error('Server call failed:', name, err);
          toast('⚠️ ' + (err && err.message ? err.message : 'Unable to reach server'));
          if(onFailure){ onFailure(err); }
        };
        if(hasRunner){
          try {
            var context = runner.withSuccessHandler(function(result){
              if(onSuccess){ onSuccess(result); }
            }).withFailureHandler(failure);
            if(typeof context[name] === 'function'){
              context[name].apply(context, args || []);
            } else {
              throw new Error('Endpoint ' + name + ' is not defined on google.script.run');
            }
          } catch (err){
            failure(err);
          }
        } else {
          console.warn('Offline mode: returning mock data for', name);
          var mock = mockData[name];
          var value = typeof mock === 'function' ? mock.apply(null, args || []) : mock;
          setTimeout(function(){ if(onSuccess){ onSuccess(value); } }, 180);
        }
      }

      function hideAllPanels(){
        $$('.panel').forEach(function(panel){
          panel.classList.remove('active');
          panel.classList.add('hidden');
        });
      }

      var panelLoaders = {
        'homepage-panel': loadHomepage,
        'profile-panel': function(){ if(session){ buildProfile(session); } },
        'qr-attendance-panel': setupQrAttendance,
        'manual-attendance-panel': function(){ setupManualAttendance(); bindManualAttendance(); },
        'attendance-trans-panel': loadMyAttendance,
        'attendance-dashboard-panel': loadKpis,
        'manage-events-panel': loadEvents,
        'directory-panel': function(){ bindDirectory(); },
        'announcements-panel': loadAnnouncements,
        'submit-feedback-panel': function(){ /* placeholder */ },
        'view-feedback-panel': loadFeedbackAdmin,
        'view-logs-panel': loadAccessLogs
      };

      function show(id){
        var target = document.getElementById(id);
        if(!target){ return; }
        hideAllPanels();
        target.classList.remove('hidden');
        target.classList.add('active');
        if(!hashNavigating){
          location.hash = id;
        }
        var loader = panelLoaders[id];
        if(typeof loader === 'function'){
          loader();
        }
      }

      function bindBackButtons(){
        $$('.back-btn').forEach(function(btn){
          if(btn.dataset.bound === '1'){ return; }
          btn.dataset.bound = '1';
          btn.addEventListener('click', function(){
            var target = btn.dataset.target || 'main-menu-panel';
            if(btn.closest('#homepage-panel')){
              target = 'login-panel';
            }
            show(target);
          });
        });
      }

      function bindLogin(){
        if(loginBound){ return; }
        loginBound = true;
        var eyeToggle = $('#eye-toggle');
        var password = $('#password');
        var username = $('#username');
        var loginBtn = $('#login-btn');
        var guestBtn = $('#guest-login-btn');

        if(eyeToggle){
          eyeToggle.addEventListener('click', function(){
            eyeToggle.classList.remove('pulse');
            void eyeToggle.offsetWidth;
            eyeToggle.classList.add('pulse');
            if(password.type === 'password'){
              password.type = 'text';
              eyeToggle.setAttribute('aria-pressed', 'true');
            } else {
              password.type = 'password';
              eyeToggle.setAttribute('aria-pressed', 'false');
            }
          });
        }

        function submitOnEnter(ev){
          if(ev.key === 'Enter'){
            ev.preventDefault();
            doLogin();
          }
        }

        if(username){ username.addEventListener('keydown', submitOnEnter); }
        if(password){ password.addEventListener('keydown', submitOnEnter); }
        if(loginBtn){ loginBtn.addEventListener('click', doLogin); }
        if(guestBtn){
          guestBtn.addEventListener('click', function(){
            var body = '<div class="form-stack">' +
              '<label for="guest-name">Enter your name</label>' +
              '<input id="guest-name" type="text" placeholder="Guest name" />' +
              '</div>';
            var footer = '<div class="panel-actions">' +
              '<button type="button" class="btn btn-secondary" data-close="1">Cancel</button>' +
              '<button type="button" class="btn btn-primary" id="confirm-guest">Continue</button>' +
              '</div>';
            showModal({ title: 'Guest Login', bodyHtml: body, footerHtml: footer, opener: guestBtn });
            var modalRoot = document.getElementById('modal-root');
            setTimeout(function(){
              var input = modalRoot ? modalRoot.querySelector('#guest-name') : null;
              var confirm = modalRoot ? modalRoot.querySelector('#confirm-guest') : null;
              if(input){ input.focus(); }
              if(confirm){
                confirm.addEventListener('click', function(){
                  var name = input ? input.value.trim() : '';
                  if(!name){ toast('Please enter your name.'); return; }
                  callServer('guestLogin', [name], function(res){
                    closeModal();
                    var payload = asPayload(res);
                    var user = payload && payload.user ? payload.user : payload;
                    if(isSuccess(res) && user){
                      setSession(user || { name: name, role: 'Guest', isGuest: true });
                      toast('Welcome, ' + (user.name || name) + '!');
                      show('homepage-panel');
                    } else {
                      toast('Unable to log in as guest.');
                    }
                  });
                });
              }
            }, 50);
          });
        }
      }

      function doLogin(){
        var username = $('#username');
        var password = $('#password');
        var status = $('#login-status');
        var userVal = username ? username.value.trim() : '';
        var passVal = password ? password.value.trim() : '';
        if(!userVal || !passVal){
          toast('Please provide both username and password.');
          if(status){ status.textContent = 'Please fill in both fields.'; }
          return;
        }
        if(status){ status.textContent = 'Signing in...'; }
        callServer('validateLogin', [userVal, passVal], function(res){
          var payload = asPayload(res);
          var user = payload && payload.user ? payload.user : (payload && payload.name ? payload : null);
          if(isSuccess(res) && user){
            if(status){ status.textContent = 'Login successful!'; }
            setSession(user);
            toast('Welcome back, ' + (user.name || 'member') + '!');
            show('main-menu-panel');
          } else {
            if(status){ status.textContent = 'Invalid credentials.'; }
            toast('Invalid credentials.');
          }
        }, function(){
          if(status){ status.textContent = 'Unable to log in.'; }
        });
      }

      function setSession(user){
        session = user || null;
        window.__SESSION__ = session;
        if(session && session.name){
          $('#dashboard-subtitle').textContent = 'Welcome, ' + session.name + '!';
        }
        buildDashboard(session);
        buildProfile(session);
      }

      function resetLoginPanel(){
        var username = $('#username');
        var password = $('#password');
        if(username){ username.value = ''; }
        if(password){ password.value = ''; password.type = 'password'; }
        $('#login-status').textContent = '';
        if($('#eye-toggle')){ $('#eye-toggle').setAttribute('aria-pressed', 'false'); }
      }

      function buildDashboard(user){
        var container = $('#dashboard-tiles');
        if(!container){ return; }
        container.innerHTML = '';
        var isGuest = user && (user.isGuest || String(user.role || '').toLowerCase() === 'guest');
        var tiles = [
          { id: 'homepage-panel', title: 'Homepage', desc: 'View announcements and org information.' },
          { id: 'profile-panel', title: 'Profile', desc: 'Review your member profile and QR ID.' },
          { id: 'qr-attendance-panel', title: 'QR Attendance', desc: 'Scan members for attendance tracking.' },
          { id: 'manual-attendance-panel', title: 'Manual Attendance', desc: 'Record attendance without QR.' },
          { id: 'attendance-trans-panel', title: 'My Attendance', desc: 'View your attendance history.' },
          { id: 'attendance-dashboard-panel', title: 'KPIs', desc: 'Visualize attendance performance.' },
          { id: 'manage-events-panel', title: 'Manage Events', desc: 'Create and manage YSP events.' },
          { id: 'announcements-panel', title: 'Announcements', desc: 'Publish updates to members.' },
          { id: 'directory-panel', title: 'Directory', desc: 'Search officers and members.' },
          { id: 'submit-feedback-panel', title: 'Submit Feedback', desc: 'Send feedback to the admins.' },
          { id: 'view-feedback-panel', title: 'Feedback Inbox', desc: 'Review submitted feedback.' },
          { id: 'view-logs-panel', title: 'Access Logs', desc: 'Monitor login and attendance logs.' }
        ];
        if(isGuest){
          tiles = tiles.filter(function(tile){
            return ['homepage-panel','directory-panel','submit-feedback-panel','attendance-trans-panel','profile-panel'].indexOf(tile.id) !== -1;
          });
        }
        tiles.forEach(function(tile){
          var el = document.createElement('button');
          el.type = 'button';
          el.className = 'tile';
          el.setAttribute('role', 'listitem');
          el.innerHTML = '<span class="tile-title">' + esc(tile.title) + '</span>' +
            '<span class="tile-desc">' + esc(tile.desc) + '</span>';
          el.addEventListener('click', function(){ show(tile.id); });
          container.appendChild(el);
        });
        var logoutTile = document.createElement('button');
        logoutTile.type = 'button';
        logoutTile.className = 'tile';
        logoutTile.innerHTML = '<span class="tile-title">Log Out</span><span class="tile-desc">Return to login screen.</span>';
        logoutTile.addEventListener('click', function(){
          callServer('logout', [], function(){
            session = null;
            window.__SESSION__ = null;
            resetLoginPanel();
            show('login-panel');
            toast('Logged out successfully.');
          });
        });
        container.appendChild(logoutTile);
      }

      function buildProfile(user){
        user = user || {};
        var nameEl = $('#profile-name');
        var roleEl = $('#profile-role');
        var emailEl = $('#profile-email');
        var idEl = $('#profile-id');
        if(nameEl){ nameEl.textContent = user.name || 'Guest Member'; }
        if(roleEl){ roleEl.textContent = user.role || 'Guest'; }
        if(emailEl){ emailEl.textContent = user.email || 'guest@example.com'; }
        if(idEl){ idEl.textContent = user.id || 'N/A'; }
        var qrContainer = $('#qrid');
        if(qrContainer){
          qrContainer.innerHTML = '';
          if(window.QRCode){
            var qr = new QRCode(qrContainer, {
              text: user.id || 'GUEST',
              width: 180,
              height: 180,
              colorDark: '#000000',
              colorLight: '#ffffff',
              correctLevel: QRCode.CorrectLevel.H
            });
            setTimeout(function(){
              var downloadBtn = $('#btn-download-qr');
              if(downloadBtn){
                downloadBtn.onclick = function(){
                  try {
                    var img = qrContainer.querySelector('img') || qrContainer.querySelector('canvas');
                    if(img){
                      var link = document.createElement('a');
                      link.download = (user.name || 'ysp-member') + '-qr.png';
                      link.href = img.src || img.toDataURL('image/png');
                      link.click();
                    }
                  } catch (err){
                    toast('Unable to download QR code.');
                  }
                };
              }
            }, 80);
          }
        }
      }

      function deriveProjectsFromFlat(map){
        if(!map){ return []; }
        if(map.projects && Array.isArray(map.projects)){ return map.projects; }
        var projects = [];
        Object.keys(map).forEach(function(key){
          if(/^projectImageUrl_/i.test(key)){
            var idx = key.split('_').pop();
            var image = map[key];
            var desc = map['projectDesc_' + idx] || '';
            projects.push({ title: 'Project ' + idx, description: desc, imageUrl: image });
          }
        });
        return projects;
      }

      function renderProjects(projects){
        var grid = $('#projects-grid');
        var empty = $('#projects-empty');
        if(!grid){ return; }
        grid.innerHTML = '';
        if(!projects || !projects.length){
          if(empty){ empty.hidden = false; }
          return;
        }
        if(empty){ empty.hidden = true; }
        projects.forEach(function(project){
          var card = document.createElement('article');
          card.className = 'card';
          card.tabIndex = 0;
          card.innerHTML = '<div class="ratio-box"><img src="' + esc(window.YSP ? YSP.safeImage(project.imageUrl, 'https://placehold.co/640x360?text=YSP+Project') : project.imageUrl) + '" alt="' + esc(project.title || 'Project image') + '"></div>' +
            '<h3>' + esc(project.title || 'Project') + '</h3>' +
            '<p>' + esc(project.description || 'No description provided.') + '</p>';
          card.addEventListener('click', function(ev){ openProjectModal(project, ev.currentTarget); });
          card.addEventListener('keydown', function(ev){ if(ev.key === 'Enter' || ev.key === ' '){ ev.preventDefault(); openProjectModal(project, ev.currentTarget); } });
          grid.appendChild(card);
        });
      }

      function openProjectModal(project, opener){
        var image = window.YSP ? YSP.safeImage(project.imageUrl, 'https://placehold.co/640x360?text=YSP+Project') : project.imageUrl;
        var body = '<div class="ratio-box"><img src="' + esc(image) + '" alt="' + esc(project.title || 'Project image') + '"></div>' +
          '<p style="margin-top:16px;">' + esc(project.description || '') + '</p>';
        showModal({ title: project.title || 'Project', bodyHtml: body, opener: opener || projectModalOpener });
      }

      function renderContacts(home){
        var fbBtn = $('#contact-fb');
        var emailBtn = $('#contact-email');
        if(fbBtn){
          fbBtn.onclick = function(){ openSafe(home && home.facebookUrl ? home.facebookUrl : 'https://www.facebook.com/ysptagum'); };
        }
        if(emailBtn){
          emailBtn.onclick = function(){
            var email = home && home.email ? home.email : 'support@ysptagum.org';
            var url = 'https://mail.google.com/mail/?view=cm&fs=1&to=' + encodeURIComponent(email) + '&su=%5BYSP%5D%20Issue%20Report';
            openSafe(url);
          };
        }
      }

      function renderHome(home){
        var data = asPayload(home);
        homepageData = data || {};
        $('#home-about').textContent = (data && data.about) || 'No information available yet.';
        $('#home-mission').textContent = (data && data.mission) || 'No mission provided.';
        $('#home-vision').textContent = (data && data.vision) || 'No vision provided.';
        $('#home-objectives').textContent = (data && data.objectives) || 'No objectives provided yet.';
        var chartImg = $('#home-org-chart');
        if(chartImg){ chartImg.src = window.YSP ? YSP.safeImage(data && data.orgChartUrl, 'https://placehold.co/1024x576?text=Org+Chart') : (data && data.orgChartUrl); }
        var projects = (data && data.projects) || deriveProjectsFromFlat(data);
        renderProjects(projects);
        renderContacts(data);
      }

      function showHomeError(){
        toast('Unable to load homepage content.');
      }

      function loadHomepage(){
        if(homepageLoaded && homepageData){
          renderHome(homepageData);
          return;
        }
        callServer('getHomepageContent', [], function(res){
          if(res && res.success){
            homepageLoaded = true;
            renderHome(res);
          } else if(res) {
            homepageLoaded = true;
            renderHome(res);
          } else {
            showHomeError();
          }
        }, showHomeError);
      }

      function bindDirectory(){
        if(directoryBound){ return; }
        directoryBound = true;
        var input = $('#search-input');
        var list = $('#suggestions-list');
        if(!input || !list){ return; }
        var debounceTimer = null;
        function renderSuggestions(items){
          list.innerHTML = '';
          if(!items || !items.length){
            list.hidden = true;
            return;
          }
          items.forEach(function(item){
            var li = document.createElement('li');
            li.tabIndex = 0;
            li.innerHTML = '<strong>' + esc(item.name) + '</strong><span class="text-muted">' + esc(item.id) + ' • ' + esc(item.role || '') + '</span>';
            li.addEventListener('click', function(){ openOfficer(item.id); list.hidden = true; });
            li.addEventListener('keydown', function(ev){ if(ev.key === 'Enter'){ openOfficer(item.id); list.hidden = true; } });
            list.appendChild(li);
          });
          list.hidden = false;
        }
        function requestSuggestions(){
          var term = input.value.trim();
          callServer('officerSuggestions', [term], function(res){
            var payload = asPayload(res);
            if(payload && (payload.suggestions || Array.isArray(payload))){
              renderSuggestions(payload.suggestions || payload);
            }
          });
        }
        input.addEventListener('input', function(){
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(requestSuggestions, 200);
        });
      }

      function openOfficer(id){
        var container = $('#officer-profile');
        if(!container){ return; }
        container.innerHTML = '<p class="text-muted">Loading profile...</p>';
        callServer('getRecordById', [id], function(res){
          var payload = asPayload(res);
          if(payload && (payload.record || payload.id || payload.name)){
            var record = payload.record || payload;
            container.innerHTML = '<div class="card">' +
              '<div class="ratio-box"><img src="' + esc(window.YSP ? YSP.safeImage(record.avatar, 'https://placehold.co/640x360?text=Profile') : record.avatar) + '" alt="' + esc(record.name || 'Officer photo') + '"></div>' +
              '<h3>' + esc(record.name || '') + '</h3>' +
              '<p>' + esc(record.role || '') + '</p>' +
              '<p><strong>ID:</strong> ' + esc(record.id || '') + '</p>' +
              '<p><strong>Email:</strong> ' + esc(record.email || 'N/A') + '</p>' +
              '<div class="panel-actions"><button type="button" class="btn btn-primary" data-mark-attendance="' + esc(record.id || '') + '">Mark Attendance</button></div>' +
              '</div>';
            var markBtn = container.querySelector('[data-mark-attendance]');
            if(markBtn){
              markBtn.addEventListener('click', function(){
                var body = '<div class="form-stack">' +
                  '<p>Select attendance status for <strong>' + esc(record.name || '') + '</strong>.</p>' +
                  '<label for="attendance-status">Status</label>' +
                  '<select id="attendance-status">' +
                    '<option value="present">Present</option>' +
                    '<option value="late">Late</option>' +
                    '<option value="absent">Absent</option>' +
                    '<option value="excused">Excused</option>' +
                  '</select>' +
                '</div>';
                var footer = '<div class="panel-actions">' +
                  '<button type="button" class="btn btn-secondary" data-close="1">Cancel</button>' +
                  '<button type="button" class="btn btn-primary" id="confirm-attendance">Save</button>' +
                  '</div>';
                showModal({ title: 'Mark Attendance', bodyHtml: body, footerHtml: footer, opener: markBtn });
                setTimeout(function(){
                  var modalRoot = document.getElementById('modal-root');
                  var confirm = modalRoot ? modalRoot.querySelector('#confirm-attendance') : null;
                  var select = modalRoot ? modalRoot.querySelector('#attendance-status') : null;
                  if(select){ select.focus(); }
                  if(confirm){
                    confirm.addEventListener('click', function(){
                      var statusValue = select ? select.value : 'present';
                      callServer('recordManualAttendance', [record.id, statusValue], function(res){
                        var payloadResult = asPayload(res);
                        if(isSuccess(res) || (payloadResult && payloadResult.message)){
                          var message = (payloadResult && payloadResult.message) || (res && res.message) || 'Attendance recorded.';
                          toast(message);
                          closeModal();
                        } else {
                          toast('Unable to record attendance.');
                        }
                      });
                    });
                  }
                }, 60);
              });
            }
          } else {
            container.innerHTML = '<p class="text-muted">Officer not found.</p>';
          }
        }, function(){ container.innerHTML = '<p class="text-muted">Unable to load profile.</p>'; });
      }

      function populateActiveEvents(selectEl){
        var select = typeof selectEl === 'string' ? $(selectEl) : selectEl;
        if(!select){ return; }
        callServer('getActiveEvents', [], function(res){
          var payload = asPayload(res);
          if(payload){
            var events = payload.events || payload;
            select.innerHTML = '<option value="">Select an event</option>';
            events.forEach(function(evt){
              var option = document.createElement('option');
              option.value = evt.id;
              option.textContent = evt.name;
              select.appendChild(option);
            });
          }
        });
      }

      function appendScanLog(message, isError){
        var log = $('#scan-log');
        if(!log){ return; }
        var entry = document.createElement('p');
        entry.textContent = message;
        if(isError){ entry.style.color = '#a01010'; }
        log.prepend(entry);
      }

      function startScanner(){
        if(scannerRunning){ return; }
        var select = $('#event-select');
        if(!select || !select.value){ toast('Select an event first.'); return; }
        var scannerEl = $('#scanner');
        if(!scannerEl){ return; }
        scannerEl.innerHTML = '';
        if(window.Html5Qrcode){
          var formats = window.Html5QrcodeSupportedFormats ? [ window.Html5QrcodeSupportedFormats.QR_CODE ] : undefined;
          html5Qr = new Html5Qrcode('scanner', {});
          var config = { fps: 10, qrbox: 250 };
          if(formats){ config.formatsToSupport = formats; }
          html5Qr.start({ facingMode: 'environment' }, config, function(decodedText){ onScan(decodedText); }, function(err){ onScanError(err); });
          scannerRunning = true;
          toast('Scanner started.');
        } else {
          toast('Scanner library not available.');
        }
      }

      function stopScanner(){
        if(html5Qr){
          html5Qr.stop().then(function(){ html5Qr.clear(); html5Qr = null; }).catch(function(err){ console.warn('Unable to stop scanner', err); });
        }
        scannerRunning = false;
        toast('Scanner stopped.');
      }

      function scanFileUpload(file){
        if(!file){ toast('Select an image to scan.'); return; }
        if(scannerRunning){ stopScanner(); }
        if(!window.Html5Qrcode){ toast('Scanner library not available.'); return; }
        var targetId = 'scan-fallback-target';
        if(!fallbackQr){
          try {
            fallbackQr = new Html5Qrcode(targetId, {});
          } catch (err){
            console.warn('Unable to initialise fallback scanner', err);
            toast('Unable to initialise fallback scanner.');
            return;
          }
        }
        fallbackQr.scanFile(file, true).then(function(decodedText){
          onScan(decodedText);
        }).catch(function(err){
          console.warn('File scan failed', err);
          toast('Unable to read QR from image.');
        });
      }

      function onScan(decodedText){
        var select = $('#event-select');
        if(!select || !select.value){ toast('Please select an event.'); return; }
        callServer('logAttendanceScan', [decodedText, select.value], function(res){
          var payload = asPayload(res);
          if(isSuccess(res) || (payload && payload.message)){
            appendScanLog('✅ ' + ((payload && payload.message) || (res && res.message) || 'Attendance recorded.'));
          } else {
            appendScanLog('⚠️ Unable to record attendance.', true);
          }
        }, function(){ appendScanLog('⚠️ Unable to record attendance.', true); });
      }

      function onScanError(err){
        console.warn('Scan error', err);
      }

      function setupQrAttendance(){
        populateActiveEvents('#event-select');
        var startBtn = $('#start-scan');
        var stopBtn = $('#stop-scan');
        var fileInput = $('#scan-file');
        var fileBtn = $('#scan-file-btn');
        if(startBtn && !startBtn.dataset.bound){
          startBtn.dataset.bound = '1';
          startBtn.addEventListener('click', startScanner);
        }
        if(stopBtn && !stopBtn.dataset.bound){
          stopBtn.dataset.bound = '1';
          stopBtn.addEventListener('click', stopScanner);
        }
        if(fileBtn && !fileBtn.dataset.bound){
          fileBtn.dataset.bound = '1';
          fileBtn.addEventListener('click', function(){
            if(!fileInput || !fileInput.files || !fileInput.files.length){
              toast('Choose an image containing a QR code.');
              return;
            }
            scanFileUpload(fileInput.files[0]);
          });
        }
      }

      function setupManualAttendance(){
        populateActiveEvents('#manual-event');
      }

      function bindManualAttendance(){
        if(manualBound){ return; }
        manualBound = true;
        var input = $('#manual-member');
        var list = $('#manual-suggestions');
        var eventSelect = $('#manual-event');
        var status = $('#manual-status');
        if(!input || !list){ return; }
        var debounceTimer = null;
        function render(items){
          list.innerHTML = '';
          if(!items || !items.length){ list.hidden = true; return; }
          items.forEach(function(item){
            var li = document.createElement('li');
            li.textContent = item.name + ' (' + item.id + ')';
            li.tabIndex = 0;
            li.addEventListener('click', function(){ input.value = item.id; list.hidden = true; });
            li.addEventListener('keydown', function(ev){ if(ev.key === 'Enter'){ input.value = item.id; list.hidden = true; } });
            list.appendChild(li);
          });
          list.hidden = false;
        }
        function request(){
          var term = input.value.trim();
          callServer('officerSuggestions', [term], function(res){
            var payload = asPayload(res);
            if(payload){ render(payload.suggestions || payload); }
          });
        }
        input.addEventListener('input', function(){
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(request, 200);
        });
        function submit(action){
          var memberId = input.value.trim();
          var eventId = eventSelect ? eventSelect.value : '';
          if(!memberId || !eventId){ toast('Complete member and event details.'); return; }
          callServer('manualAttendance', [memberId, eventId, action], function(res){
            var payload = asPayload(res);
            if(isSuccess(res) || (payload && payload.message)){
              var message = (payload && payload.message) || (res && res.message) || 'Attendance recorded.';
              status.textContent = message;
              toast(message);
            } else {
              status.textContent = 'Unable to record attendance.';
              toast('Unable to record attendance.');
            }
          }, function(){ status.textContent = 'Unable to record attendance.'; });
        }
        var inBtn = $('#manual-time-in');
        var outBtn = $('#manual-time-out');
        if(inBtn){ inBtn.addEventListener('click', function(){ submit('in'); }); }
        if(outBtn){ outBtn.addEventListener('click', function(){ submit('out'); }); }
      }

      function loadMyAttendance(){
        callServer('getMyAttendance', [], function(res){
          var container = $('#attendance-table');
          if(!container){ return; }
          var payload = asPayload(res);
          if(payload){
            var rows = payload.rows || payload;
            if(!rows.length){ container.innerHTML = '<div class="list-empty">No attendance records yet.</div>'; return; }
            var html = '<table><thead><tr><th>Date</th><th>Event</th><th>Time In</th><th>Time Out</th></tr></thead><tbody>';
            rows.forEach(function(row){
              html += '<tr><td>' + esc(row.date || '') + '</td><td>' + esc(row.event || '') + '</td><td>' + esc(row.timeIn || '') + '</td><td>' + esc(row.timeOut || '') + '</td></tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
          } else {
            container.innerHTML = '<div class="list-empty">Unable to load attendance.</div>';
          }
        }, function(){
          var container = $('#attendance-table');
          if(container){ container.innerHTML = '<div class="list-empty">Unable to load attendance.</div>'; }
        });
      }

      function renderKpiChart(canvas, kpi){
        if(!canvas || !window.Chart || !kpi){ return; }
        if(kpiChart){ kpiChart.destroy(); }
        var ctx = canvas.getContext('2d');
        kpiChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: kpi.labels || [],
            datasets: [
              { label: 'Present', backgroundColor: 'rgba(246,66,31,0.85)', data: kpi.present || [] },
              { label: 'Absent', backgroundColor: 'rgba(0,0,0,0.25)', data: kpi.absent || [] }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } },
            scales: { y: { beginAtZero: true } }
          }
        });
      }

      function loadKpis(){
        callServer('getAttendanceKPIs', [], function(res){
          var statsContainer = $('#kpi-stats');
          if(res && statsContainer){
            statsContainer.innerHTML = '';
            var payload = res && res.data ? res.data : res;
            var stats = payload.stats || {};
            var items = [
              { label: 'Total Events', value: stats.totalEvents || 0 },
              { label: 'Present', value: stats.present || 0 },
              { label: 'Absent', value: stats.absent || 0 },
              { label: 'Late', value: stats.late || 0 }
            ];
            items.forEach(function(item){
              var card = document.createElement('div');
              card.className = 'stat-card';
              card.innerHTML = '<span>' + esc(item.label) + '</span><strong>' + esc(item.value) + '</strong>';
              statsContainer.appendChild(card);
            });
            renderKpiChart($('#kpi-canvas'), payload.kpi || {});
          }
        });
      }

      function renderEvents(list){
        var container = $('#events-table');
        if(!container){ return; }
        if(!list || !list.length){ container.innerHTML = '<div class="list-empty">No events yet.</div>'; return; }
        var html = '<table><thead><tr><th>Event</th><th>Date</th><th>Status</th><th></th></tr></thead><tbody>';
        list.forEach(function(evt){
          html += '<tr>' +
            '<td>' + esc(evt.name || '') + '</td>' +
            '<td>' + esc(evt.date || '') + '</td>' +
            '<td><span class="status-chip ' + (evt.active ? '' : 'warn') + '">' + (evt.active ? 'Active' : 'Inactive') + '</span></td>' +
            '<td><button class="btn btn-secondary" data-toggle-event="' + esc(evt.id || '') + '">' + (evt.active ? 'Deactivate' : 'Activate') + '</button></td>' +
            '</tr>';
        });
        html += '</tbody></table>';
        container.innerHTML = html;
        $$('#events-table [data-toggle-event]').forEach(function(btn){
          btn.addEventListener('click', function(){
            var id = btn.getAttribute('data-toggle-event');
            callServer('toggleEventActive', [id], function(res){
              var payload = asPayload(res);
              var message = (payload && payload.message) || (res && res.message) || 'Event updated.';
              if(!isSuccess(res) && !(payload && payload.message)){
                toast('Unable to update event.');
                return;
              }
              toast(message);
              loadEvents();
            });
          });
        });
      }

      function loadEvents(){
        callServer('listEvents', [], function(res){
          var payload = asPayload(res);
          if(payload){ renderEvents(payload.events || payload); }
        });
        var createBtn = $('#btn-create-event');
        if(createBtn && !createBtn.dataset.bound){
          createBtn.dataset.bound = '1';
          createBtn.addEventListener('click', function(){
            var body = '<div class="form-stack">' +
              '<label for="event-name">Event Name</label>' +
              '<input id="event-name" type="text" />' +
              '<label for="event-date">Date</label>' +
              '<input id="event-date" type="date" />' +
              '</div>';
            var footer = '<div class="panel-actions">' +
              '<button type="button" class="btn btn-secondary" data-close="1">Cancel</button>' +
              '<button type="button" class="btn btn-primary" id="save-event">Save</button>' +
              '</div>';
            showModal({ title: 'Create Event', bodyHtml: body, footerHtml: footer, opener: createBtn });
            var modalRoot = document.getElementById('modal-root');
            setTimeout(function(){
              var saveBtn = modalRoot ? modalRoot.querySelector('#save-event') : null;
              var nameInput = modalRoot ? modalRoot.querySelector('#event-name') : null;
              var dateInput = modalRoot ? modalRoot.querySelector('#event-date') : null;
              if(nameInput){ nameInput.focus(); }
              if(saveBtn){
                saveBtn.addEventListener('click', function(){
                  var payload = { name: nameInput.value.trim(), date: dateInput.value };
                  if(!payload.name || !payload.date){ toast('Complete event details.'); return; }
                  callServer('createEvent', [payload], function(res){
                    var response = asPayload(res);
                    var message = (response && response.message) || (res && res.message) || 'Event created.';
                    if(!isSuccess(res) && !(response && response.message)){
                      toast('Unable to create event.');
                      return;
                    }
                    toast(message);
                    closeModal();
                    loadEvents();
                  });
                });
              }
            }, 80);
          });
        }
      }

      function loadAnnouncements(){
        callServer('listAnnouncements', [{}], function(res){
          var list = $('#announcements-list');
          if(!list){ return; }
          list.innerHTML = '';
          var payload = asPayload(res);
          if(payload){
            var items = payload.announcements || payload;
            if(!items.length){ list.innerHTML = '<div class="list-empty">No announcements yet.</div>'; return; }
            items.forEach(function(item){
              var card = document.createElement('article');
              card.className = 'card';
              card.style.borderLeft = '6px solid ' + (item.isUnread ? 'var(--primary)' : 'rgba(0,0,0,0.1)');
              card.innerHTML = '<h3>' + esc(item.title || '') + '</h3>' +
                '<p>' + esc(item.body || '') + '</p>' +
                '<p class="text-muted">' + esc(item.createdAt || '') + '</p>';
              list.appendChild(card);
            });
          }
        });
        var createBtn = $('#btn-create-announcement');
        if(createBtn && !createBtn.dataset.bound){
          createBtn.dataset.bound = '1';
          createBtn.addEventListener('click', function(){
            var body = '<div class="form-stack">' +
              '<label for="announcement-title">Title</label>' +
              '<input id="announcement-title" type="text" />' +
              '<label for="announcement-body">Message</label>' +
              '<textarea id="announcement-body" rows="4"></textarea>' +
              '</div>';
            var footer = '<div class="panel-actions">' +
              '<button type="button" class="btn btn-secondary" data-close="1">Cancel</button>' +
              '<button type="button" class="btn btn-primary" id="save-announcement">Post</button>' +
              '</div>';
            showModal({ title: 'Create Announcement', bodyHtml: body, footerHtml: footer, opener: createBtn });
            setTimeout(function(){
              var modalRoot = document.getElementById('modal-root');
              var saveBtn = modalRoot ? modalRoot.querySelector('#save-announcement') : null;
              var titleInput = modalRoot ? modalRoot.querySelector('#announcement-title') : null;
              var bodyInput = modalRoot ? modalRoot.querySelector('#announcement-body') : null;
              if(titleInput){ titleInput.focus(); }
            if(saveBtn){
              saveBtn.addEventListener('click', function(){
                var payload = { title: titleInput.value.trim(), body: bodyInput.value.trim() };
                if(!payload.title || !payload.body){ toast('Complete announcement details.'); return; }
                callServer('createAnnouncement', [payload], function(res){
                  var response = asPayload(res);
                  var message = (response && response.message) || (res && res.message) || 'Announcement posted.';
                  if(!isSuccess(res) && !(response && response.message)){
                    toast('Unable to post announcement.');
                    return;
                  }
                  toast(message);
                  closeModal();
                  loadAnnouncements();
                });
              });
              }
            }, 80);
          });
        }
      }

      function loadMyFeedback(){
        callServer('listMyFeedback', [], function(res){
          var status = $('#feedback-status');
          if(status && isSuccess(res)){
            status.textContent = '';
          }
        });
      }

      function loadFeedbackAdmin(){
        callServer('listAllFeedback', [], function(res){
          var list = $('#feedback-list');
          if(!list){ return; }
          list.innerHTML = '';
          var payload = asPayload(res);
          if(payload){
            var items = payload.feedback || payload;
            if(!items.length){ list.innerHTML = '<div class="list-empty">No feedback entries.</div>'; return; }
            items.forEach(function(item){
              var card = document.createElement('article');
              card.className = 'card';
              card.innerHTML = '<h3>' + esc(item.name || 'Anonymous') + '</h3>' +
                '<p>' + esc(item.message || '') + '</p>' +
                '<p class="text-muted">' + esc(item.createdAt || '') + '</p>';
              list.appendChild(card);
            });
          }
        });
      }

      function sendFeedback(){
        var text = $('#feedback-text');
        var status = $('#feedback-status');
        var message = text ? text.value.trim() : '';
        if(!message){ toast('Please write your feedback.'); return; }
        callServer('sendFeedback', [message], function(res){
          var payload = asPayload(res);
          if(isSuccess(res) || (payload && payload.message)){
            var note = (payload && payload.message) || (res && res.message) || 'Feedback sent.';
            toast(note);
            if(text){ text.value = ''; }
            if(status){ status.textContent = 'Feedback submitted successfully.'; }
          } else {
            toast('Unable to send feedback.');
            if(status){ status.textContent = 'Unable to send feedback.'; }
          }
        }, function(){ if(status){ status.textContent = 'Unable to send feedback.'; } });
      }

      function loadAccessLogs(){
        callServer('getAccessLogs', [], function(res){
          var container = $('#logs-table');
          if(!container){ return; }
          var payload = asPayload(res);
          if(payload){
            var logs = payload.logs || payload;
            if(!logs.length){ container.innerHTML = '<div class="list-empty">No logs available.</div>'; return; }
            var html = '<table><thead><tr><th>Timestamp</th><th>ID Code</th><th>Name</th></tr></thead><tbody>';
            logs.forEach(function(log){
              html += '<tr><td>' + esc(log.timestamp || '') + '</td><td>' + esc(log.id || '') + '</td><td>' + esc(log.name || '') + '</td></tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
          }
        });
      }

      function bindFeedbackSend(){
        var btn = $('#btn-send-feedback');
        if(btn && !btn.dataset.bound){
          btn.dataset.bound = '1';
          btn.addEventListener('click', sendFeedback);
        }
      }

      function bindHashRouting(){
        window.addEventListener('hashchange', function(){
          var id = location.hash.replace('#', '');
          if(document.getElementById(id)){
            hashNavigating = true;
            show(id);
            hashNavigating = false;
          }
        });
      }

      function attemptRestoreSession(){
        callServer('getSession', [], function(res){
          var payload = asPayload(res);
          var user = payload && payload.user ? payload.user : payload;
          if(isSuccess(res) && user && user.name){
            setSession(user);
            show('main-menu-panel');
          } else {
            show('login-panel');
          }
        }, function(){ show('login-panel'); });
      }

      function init(){
        bindBackButtons();
        bindLogin();
        bindDirectory();
        bindManualAttendance();
        bindFeedbackSend();
        bindHashRouting();

        var feedbackText = $('#feedback-text');
        if(feedbackText){
          feedbackText.addEventListener('focus', loadMyFeedback, { once: true });
        }

        var initial = location.hash ? location.hash.replace('#','') : 'login-panel';
        if(!document.getElementById(initial)){
          initial = 'login-panel';
        }
        hashNavigating = true;
        show(initial);
        hashNavigating = false;

        attemptRestoreSession();
        console.log('✅ YSP Web App Initialized OK');
      }

      window.onReady = onReady;
      window.$ = $;
      window.$$ = $$;
      window.esc = esc;
      window.show = show;
      window.bindBackButtons = bindBackButtons;
      window.toast = toast;
      window.openSafe = openSafe;
      window.showModal = showModal;
      window.closeModal = closeModal;

      onReady(init);
    })();
  </script>
</body>
</html>
