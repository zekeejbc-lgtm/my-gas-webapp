<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YSPT QR Attendance Scanner</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<link rel="icon" href="https://i.imgur.com/J4wddTW.png">

<style>
  @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@600&family=Roboto:wght@400&display=swap');
  :root{
    --primary:#f6421f;
    --secondary:#ee8724;
    --tertiary:#fbcb29;
    --text-dark:#212121;
    --text-light:#fff;
    --card-bg:rgba(255,255,255,0.96);
    --card-border:rgba(255,255,255,0.55);
    --input-bg:rgba(0,0,0,0.04);
    --shadow:rgba(0,0,0,0.12);
    --success:#34c759;
    --error:#ff3b30;
    --space-xs: clamp(8px,1.6vh,12px);
    --space-sm: clamp(12px,2vh,18px);
    --space-md: clamp(18px,3vh,26px);
    --space-lg: clamp(22px,4vh,36px);
  }
  body{
    margin:0;
    font-family:'Roboto',sans-serif;
    display:grid;
    place-items:center;
    min-height:100dvh;
    background:linear-gradient(135deg,var(--primary),var(--secondary),var(--tertiary));
    background-size:400% 400%;
    animation:gradient 18s ease infinite;
    color:var(--text-dark);
    padding:clamp(28px,7vw,64px) clamp(18px,5vw,44px);
    overflow-x:hidden;
    position:relative;
    row-gap:var(--space-lg);
  }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    background:linear-gradient(160deg,rgba(255,255,255,0.18),rgba(255,255,255,0.06));
    pointer-events:none;
    z-index:0;
  }
  @keyframes gradient{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  @media (prefers-reduced-motion: reduce){
    body{animation:none;background-size:auto;}
  }
  .container{
    width:min(100%,640px);
    background:var(--card-bg);
    border-radius:22px;
    padding:var(--space-md);
    box-shadow:0 18px 48px rgba(0,0,0,0.18);
    display:flex;
    flex-direction:column;
    align-items:center;
    text-align:center;
    gap:var(--space-md);
    margin:0 auto;
    backdrop-filter:blur(8px);
    border:1px solid var(--card-border);
    z-index:1;
  }
  .scanner-header{ display:flex; flex-direction:column; align-items:center; gap:var(--space-xs); margin:0 auto; max-width:min(100%,520px); }
  .logo{
    width:clamp(72px,12vw,98px);
    height:clamp(72px,12vw,98px);
    margin:0 auto var(--space-xs);
    display:block;
    padding:16px;
    border-radius:999px;
    background:radial-gradient(circle at 30% 30%,rgba(255,255,255,0.96),rgba(255,255,255,0.62));
    box-shadow:0 0 0 6px rgba(255,255,255,0.32),0 20px 38px rgba(0,0,0,0.2);
    border:1px solid rgba(255,255,255,0.6);
  }
  h1{ font-family:'Lexend',sans-serif; font-size:clamp(1.4rem,2vw + 1rem,1.9rem); color:var(--primary); margin:0; text-align:center; line-height:1.2; }
  .scanner-subtitle{ margin:0; font-size:0.98rem; color:rgba(0,0,0,0.7); max-width:32ch; }
  .btn{
    display:inline-flex;
    justify-content:center;
    align-items:center;
    padding:0.75rem 1.4rem;
    border-radius:12px;
    border:none;
    background:var(--primary);
    color:var(--text-light);
    font-family:'Lexend';
    cursor:pointer;
    transition:transform .2s ease, box-shadow .2s ease, filter .2s ease;
    margin:0.25rem;
    min-height:44px;
    min-width:140px;
  }
  .btn:hover{ transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,0.18); }
  .btn:focus-visible{ outline:3px solid rgba(246,66,31,0.35); outline-offset:2px; }
  .btn.secondary{ background:transparent; color:var(--primary); border:2px solid var(--primary); box-shadow:none; }
  .action-group{ display:flex; flex-wrap:wrap; justify-content:center; gap:var(--space-xs); }
  #reader{ width:100%; max-width:440px; margin:0 auto; border-radius:16px; overflow:hidden; background:rgba(0,0,0,0.08); aspect-ratio:3/4; display:flex; align-items:center; justify-content:center; box-shadow:inset 0 0 0 2px rgba(0,0,0,0.06); }
  #status-msg{ font-weight:600; min-height:1.5rem; transition:opacity .3s ease, transform .3s ease; }
  #status-msg[data-state="success"]{ color:var(--success); }
  #status-msg[data-state="error"]{ color:var(--error); }
  #status-msg[data-state]{ opacity:1; }
  .status-muted{ color:rgba(0,0,0,0.55); font-size:0.9rem; }
  .success{ animation:fadeout 4s forwards }
  .error{ animation:fadeout 4s forwards }
  @keyframes fadeout{0%{opacity:1}90%{opacity:1}100%{opacity:0}}
  /* Modal for manual attendance */
  #modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000; padding:16px; }
  .modal{ background:var(--card-bg); border-radius:16px; padding:clamp(20px,4vw,28px); width:90%; max-width:420px; text-align:left; box-shadow:0 14px 32px rgba(0,0,0,0.18); display:flex; flex-direction:column; gap:12px; max-height:90vh; overflow:auto; }
  label{ display:block; font-weight:600; margin-bottom:0.4rem }
  input, select{
    width:100%; padding:0.75rem 0.9rem;
    border-radius:12px; border:1px solid rgba(0,0,0,0.12);
    background:var(--input-bg);
    margin-bottom:1rem;
    font-size:1rem;
    transition:border-color .15s ease, box-shadow .15s ease;
  }
  input:focus, select:focus{ border-color:rgba(0,0,0,0.3); box-shadow:0 0 0 4px rgba(246,66,31,0.08); outline:none; }
  @media (min-width:1024px){
    body{ padding-block:clamp(48px,10vh,120px); }
    .container{ gap:var(--space-lg); padding:clamp(26px,3vw,40px); }
    #reader{ max-width:480px; }
  }
  @media (max-width:640px){
    body{ padding:clamp(18px,9vw,30px) clamp(12px,6vw,22px); }
    .container{ padding:clamp(18px,6vw,26px); border-radius:18px; }
    .btn{ width:100%; }
    .action-group{ gap:var(--space-xs); }
  }
  @media (max-width:420px){
    body{ padding:18px 12px; }
    h1{ font-size:1.35rem; }
    .logo{ width:72px; height:72px; padding:10px; }
    #reader{ aspect-ratio:1/1; }
  }
</style>
</head>

<body>
  <div class="container">
    <header class="scanner-header">
      <img src="https://i.imgur.com/J4wddTW.png" alt="logo" class="logo">
      <h1>Attendance Scanner</h1>
      <p class="scanner-subtitle">Scan QR codes to mark participants as <strong>Present</strong> instantly.</p>
    </header>

    <div class="action-group">
      <button class="btn" id="manual-entry-btn">Manual Entry</button>
      <button class="btn secondary" id="flip-camera-btn" hidden>Flip Camera</button>
      <button class="btn secondary" id="back-btn">Back to Menu</button>
    </div>

    <div id="reader" aria-label="QR code camera preview"></div>
    <div id="status-msg" class="status-muted" role="status" aria-live="polite">Initializing cameraâ€¦</div>
  </div>

  <!-- Modal for Manual Attendance -->
  <div id="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="manual-entry-heading">
      <h3 id="manual-entry-heading" style="font-family:'Lexend';color:var(--primary)">Manual Attendance Entry</h3>
      <label for="manual-id">Member ID Code</label>
      <input type="text" id="manual-id" placeholder="e.g. YSPTMB-25901">
      <label for="manual-status">Status</label>
      <select id="manual-status">
        <option value="Present">Present</option>
        <option value="Late">Late</option>
        <option value="Absent">Absent</option>
        <option value="Excused">Excused</option>
      </select>
      <div style="text-align:right">
        <button class="btn secondary" id="cancel-manual">Cancel</button>
        <button class="btn" id="save-manual">Save</button>
      </div>
    </div>
  </div>

<script>
let html5QrCode;
let availableCameras = [];
let activeCameraIndex = 0;
let isStartingScanner = false;
let resizeTimer = null;

const statusMsg = document.getElementById('status-msg');
const modal = document.getElementById('modal-backdrop');
const manualIdInput = document.getElementById('manual-id');
const manualStatusSelect = document.getElementById('manual-status');
const manualEntryBtn = document.getElementById('manual-entry-btn');
const cancelManualBtn = document.getElementById('cancel-manual');
const saveManualBtn = document.getElementById('save-manual');
const flipCameraBtn = document.getElementById('flip-camera-btn');
const backBtn = document.getElementById('back-btn');

function showStatus(message, type='success', persist=false){
  if(!statusMsg) return;
  statusMsg.textContent = message;
  if(type){
    statusMsg.dataset.state = type;
  } else {
    statusMsg.removeAttribute('data-state');
  }
  statusMsg.classList.remove('status-muted');
  if(!persist){
    const currentMessage = message;
    setTimeout(()=>{
      if(statusMsg.textContent === currentMessage){
        statusMsg.textContent = '';
        statusMsg.removeAttribute('data-state');
        statusMsg.classList.add('status-muted');
      }
    }, 4000);
  }
}

function computeQrBox(){
  const maxSize = Math.min(window.innerWidth - 80, 420);
  const size = Math.max(220, Math.min(maxSize, window.innerHeight * 0.45));
  return { width: size, height: size };
}

async function startScanner(cameraId){
  if(isStartingScanner) return;
  if(typeof Html5Qrcode === 'undefined'){
    showStatus('Scanner library missing.', 'error', true);
    return;
  }
  isStartingScanner = true;
  try{
    if(html5QrCode){
      await html5QrCode.stop().catch(()=>{});
      await html5QrCode.clear().catch(()=>{});
    }
    html5QrCode = new Html5Qrcode('reader');
    const config = { fps:12, qrbox: computeQrBox() };
    const cameraConfig = cameraId ? { deviceId: { exact: cameraId } } : { facingMode: 'environment' };
    await html5QrCode.start(cameraConfig, config, onScanSuccess, () => {});
  } catch(err){
    console.error(err);
    showStatus('Camera access error.', 'error', true);
  } finally {
    isStartingScanner = false;
  }
}

function onScanSuccess(decodedText){
  if(!decodedText) return;
  try{
    html5QrCode.pause();
  } catch(_){}
  handleScan(decodedText);
  setTimeout(()=> html5QrCode && html5QrCode.resume().catch(()=>{}), 2200);
}

async function setupScanner(){
  if(typeof Html5Qrcode === 'undefined'){
    showStatus('Scanner library missing.', 'error', true);
    return;
  }
  showStatus('Requesting camera accessâ€¦', 'success', true);
  try{
    availableCameras = await Html5Qrcode.getCameras();
  } catch(err){
    console.error(err);
    availableCameras = [];
  }
  flipCameraBtn.hidden = !availableCameras || availableCameras.length < 2;
  const cameraId = availableCameras.length ? availableCameras[activeCameraIndex].id : undefined;
  await startScanner(cameraId);
  if(availableCameras.length){
    const label = availableCameras[activeCameraIndex].label || 'camera';
    showStatus(`Camera ready (${label}). Point to a member QR.`, 'success');
  } else {
    showStatus('Camera ready. Point to a member QR.', 'success');
  }
}

// Handle scanned code
function handleScan(idCode){
  if(!idCode) return;
  showStatus(`Processing ${idCode}...`, 'success');
  if(typeof google === 'undefined' || !google.script){
    setTimeout(()=> showStatus(`(Local test) Marked ${idCode} as Present`, 'success'), 1000);
    return;
  }
  google.script.run.withSuccessHandler(res=>{
    if(res && res.success){
      showStatus(`âœ… ${idCode} marked as Present`, 'success');
    } else {
      showStatus(res && res.message ? res.message : 'Failed to record.', 'error');
    }
  }).withFailureHandler(err=>{
    console.error(err);
    showStatus('Connection error.', 'error');
  }).recordAttendanceScan(idCode);
}

function toggleModal(open){
  modal.style.display = open ? 'flex' : 'none';
  modal.setAttribute('aria-hidden', open ? 'false' : 'true');
  if(open){
    try{
      manualIdInput.focus({ preventScroll:true });
    } catch(_) {
      manualIdInput.focus();
    }
  } else {
    manualIdInput.value = '';
    manualStatusSelect.value = 'Present';
  }
}

manualEntryBtn.addEventListener('click', ()=> toggleModal(true));
cancelManualBtn.addEventListener('click', ()=> toggleModal(false));
modal.addEventListener('click', (event) => {
  if(event.target === modal){
    toggleModal(false);
  }
});
document.addEventListener('keydown', (event) => {
  if(event.key === 'Escape' && modal.style.display === 'flex'){
    toggleModal(false);
  }
});

saveManualBtn.addEventListener('click', ()=>{
  const id = manualIdInput.value.trim();
  const status = manualStatusSelect.value;
  if(!id){ showStatus("Please enter an ID code.","error"); return; }
  toggleModal(false);
  showStatus(`Recording ${id} as ${status}...`);
  if(typeof google === 'undefined' || !google.script){
    setTimeout(()=> showStatus(`(Local test) Recorded ${id} as ${status}`,'success'),1000);
    return;
  }
  google.script.run.withSuccessHandler(res=>{
    if(res && res.success){
      showStatus(`âœ… ${id} marked as ${status}`,'success');
    } else {
      showStatus(res.message || "Failed to record.","error");
    }
  }).withFailureHandler(err=>{
    console.error(err);
    showStatus("Connection error.","error");
  }).recordManualAttendance(id,status);
});

flipCameraBtn.addEventListener('click', async () => {
  if(!availableCameras.length){
    showStatus('No additional cameras detected.', 'error');
    return;
  }
  activeCameraIndex = (activeCameraIndex + 1) % availableCameras.length;
  const cameraId = availableCameras[activeCameraIndex].id;
  await startScanner(cameraId);
  const label = availableCameras[activeCameraIndex].label || 'camera';
  showStatus(`Switched to ${label}.`, 'success');
});

// Back to menu
backBtn.addEventListener('click', ()=>{
  if(typeof google !== 'undefined' && google.script){
    google.script.host.close();
  } else {
    window.close();
  }
});

window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    const cameraId = availableCameras.length ? availableCameras[activeCameraIndex].id : undefined;
    startScanner(cameraId);
  }, 320);
});

// Start camera when ready
window.addEventListener('load', setupScanner);
</script>
</body>
</html>
