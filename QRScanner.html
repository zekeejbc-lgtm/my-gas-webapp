<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YSPT QR Attendance Scanner</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<link rel="icon" href="https://i.imgur.com/J4wddTW.png">

<style>
  @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@600&family=Roboto:wght@400&display=swap');
  :root{
    --primary:#f6421f;
    --secondary:#ee8724;
    --tertiary:#fbcb29;
    --text-dark:#212121;
    --text-light:#fff;
    --card-bg:rgba(255,255,255,0.96);
    --card-border:rgba(255,255,255,0.55);
    --input-bg:rgba(0,0,0,0.04);
    --shadow:rgba(0,0,0,0.12);
    --success:#34c759;
    --error:#ff3b30;
    --space-xs: clamp(8px,1.6vh,12px);
    --space-sm: clamp(12px,2vh,18px);
    --space-md: clamp(18px,3vh,26px);
    --space-lg: clamp(22px,4vh,36px);
  }
  body{
    margin:0;
    font-family:'Roboto',sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    min-height:100dvh;
    background:linear-gradient(135deg,var(--primary),var(--secondary),var(--tertiary));
    background-size:400% 400%;
    animation:gradient 18s ease infinite;
    color:var(--text-dark);
    padding:clamp(28px,7vw,64px) clamp(18px,5vw,44px);
    gap:var(--space-lg);
    overflow-x:hidden;
    position:relative;
  }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    background:linear-gradient(160deg,rgba(255,255,255,0.18),rgba(255,255,255,0.06));
    pointer-events:none;
    z-index:0;
  }
  @keyframes gradient{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  @media (prefers-reduced-motion: reduce){
    body{animation:none;background-size:auto;}
  }
  .container{
    width:min(100%,720px);
    background:var(--card-bg);
    border-radius:22px;
    padding:var(--space-md);
    box-shadow:0 18px 48px rgba(0,0,0,0.18);
    display:flex;
    flex-direction:column;
    align-items:center;
    text-align:center;
    gap:var(--space-md);
    margin:0 auto;
    backdrop-filter:blur(8px);
    border:1px solid var(--card-border);
    z-index:1;
  }
  .scanner-header{ display:flex; flex-direction:column; align-items:center; gap:var(--space-xs); }
  .logo{ width:78px; height:78px; margin:0 auto var(--space-xs); display:block; }
  h1{ font-family:'Lexend',sans-serif; font-size:1.7rem; color:var(--primary); margin:0; text-align:center; }
  .scanner-subtitle{ margin:0; font-size:0.96rem; color:rgba(0,0,0,0.7); max-width:30ch; }
  .btn{
    display:inline-flex;
    justify-content:center;
    align-items:center;
    padding:0.75rem 1.4rem;
    border-radius:12px;
    border:none;
    background:var(--primary);
    color:var(--text-light);
    font-family:'Lexend';
    cursor:pointer;
    transition:transform .2s ease, box-shadow .2s ease, filter .2s ease;
    margin:0.25rem;
    min-height:44px;
    min-width:140px;
  }
  .btn:hover{ transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,0.18); }
  .btn:focus-visible{ outline:3px solid rgba(246,66,31,0.35); outline-offset:2px; }
  .btn.secondary{ background:transparent; color:var(--primary); border:2px solid var(--primary); box-shadow:none; }
  .action-group{ display:flex; flex-wrap:wrap; justify-content:center; gap:var(--space-xs); }
  #reader{ width:100%; max-width:440px; margin:0 auto; border-radius:16px; overflow:hidden; background:rgba(0,0,0,0.08); aspect-ratio:3/4; display:flex; align-items:center; justify-content:center; box-shadow:inset 0 0 0 2px rgba(0,0,0,0.06); }
  #status-msg{ font-weight:600; min-height:1.5rem; transition:opacity .3s ease, transform .3s ease; }
  #status-msg[data-state="success"]{ color:var(--success); }
  #status-msg[data-state="error"]{ color:var(--error); }
  #status-msg[data-state]{ opacity:1; }
  .status-muted{ color:rgba(0,0,0,0.55); font-size:0.9rem; }
  .success{ animation:fadeout 4s forwards }
  .error{ animation:fadeout 4s forwards }
  @keyframes fadeout{0%{opacity:1}90%{opacity:1}100%{opacity:0}}
  /* Modal for manual attendance */
  .modal-root{ position:fixed; inset:0; pointer-events:none; z-index:1000; }
  .modal-backdrop{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; padding:16px; background:rgba(0,0,0,0.45); opacity:0; transition:opacity .24s ease; pointer-events:auto; }
  .modal-backdrop.is-open{ opacity:1; }
  .modal{ background:var(--card-bg); border-radius:18px; padding:clamp(20px,4vw,28px); width:min(90vw,420px); box-shadow:0 18px 40px rgba(0,0,0,0.22); opacity:0; transform:translateY(16px); transition:transform .24s ease, opacity .24s ease; }
  .modal.is-open{ opacity:1; transform:translateY(0); }
  .modal__panel{ display:flex; flex-direction:column; gap:12px; max-height:85vh; overflow:auto; }
  .modal__header{ display:flex; align-items:center; justify-content:space-between; gap:12px; border-bottom:1px solid rgba(0,0,0,0.08); padding-bottom:8px; }
  .modal__title{ font-family:'Lexend'; color:var(--primary); font-size:1.18rem; margin:0; }
  .modal__close{ background:none; border:none; font-size:1.6rem; line-height:1; cursor:pointer; color:var(--primary); padding:4px 8px; border-radius:8px; }
  .modal__close:hover{ background:rgba(0,0,0,0.05); }
  .modal__body{ display:flex; flex-direction:column; gap:12px; font-size:0.95rem; }
  .modal__footer{ display:flex; justify-content:flex-end; flex-wrap:wrap; gap:10px; margin-top:8px; }
  label{ display:block; font-weight:600; margin-bottom:0.4rem }
  input, select{
    width:100%; padding:0.75rem 0.9rem;
    border-radius:12px; border:1px solid rgba(0,0,0,0.12);
    background:var(--input-bg);
    margin-bottom:1rem;
    font-size:1rem;
    transition:border-color .15s ease, box-shadow .15s ease;
  }
  input:focus, select:focus{ border-color:rgba(0,0,0,0.3); box-shadow:0 0 0 4px rgba(246,66,31,0.08); outline:none; }
  @media (min-width:1024px){
    body{ padding-block:clamp(48px,10vh,120px); }
    .container{ gap:var(--space-lg); padding:clamp(26px,3vw,40px); }
    #reader{ max-width:480px; }
  }
  @media (max-width:640px){
    .container{ padding:clamp(18px,6vw,26px); border-radius:18px; }
    .btn{ width:100%; }
    .action-group{ gap:var(--space-xs); }
  }
  @media (max-width:420px){
    body{ padding:16px 12px; }
    h1{ font-size:1.35rem; }
    #reader{ aspect-ratio:1/1; }
  }
</style>
</head>

<body>
  <div class="container">
    <header class="scanner-header">
      <img src="https://i.imgur.com/J4wddTW.png" alt="logo" class="logo">
      <h1>Attendance Scanner</h1>
      <p class="scanner-subtitle">Scan QR codes to mark participants as <strong>Present</strong> instantly.</p>
    </header>

    <div class="action-group">
      <button class="btn" id="manual-entry-btn">Manual Entry</button>
      <button class="btn secondary" id="upload-qr-btn">Upload QR Image</button>
      <button class="btn secondary" id="flip-camera-btn" hidden>Flip Camera</button>
      <button class="btn secondary" id="back-btn">Back to Menu</button>
    </div>

    <div id="reader" aria-label="QR code camera preview"></div>
    <div id="status-msg" class="status-muted" role="status" aria-live="polite">Initializing camera…</div>
  </div>

  <input type="file" id="qr-file-input" accept="image/*" hidden>


<script>
(function(){
  function onReady(fn){
    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', fn);
    } else {
      fn();
    }
  }

  onReady(function(){
    var html5QrCode = null;
    var availableCameras = [];
    var activeCameraIndex = 0;
    var isStartingScanner = false;
    var resizeTimer = null;

    var statusMsg = document.getElementById('status-msg');
    var modal = document.getElementById('modal-backdrop');
    var manualIdInput = document.getElementById('manual-id');
    var manualStatusSelect = document.getElementById('manual-status');
    var manualEntryBtn = document.getElementById('manual-entry-btn');
    var cancelManualBtn = document.getElementById('cancel-manual');
    var saveManualBtn = document.getElementById('save-manual');
    var flipCameraBtn = document.getElementById('flip-camera-btn');
    var backBtn = document.getElementById('back-btn');

    function showStatus(message, type, persist){
      if(!statusMsg) return;
      var nextType = typeof type === 'string' ? type : '';
      statusMsg.textContent = message || '';
      if(nextType){
        statusMsg.dataset.state = nextType;
      } else {
        statusMsg.removeAttribute('data-state');
      }
      if(!message){
        statusMsg.classList.add('status-muted');
      } else {
        statusMsg.classList.remove('status-muted');
      }
      if(persist){
        return;
      }
      var currentMessage = message;
      setTimeout(function(){
        if(statusMsg.textContent === currentMessage){
          statusMsg.textContent = '';
          statusMsg.removeAttribute('data-state');
          statusMsg.classList.add('status-muted');
        }
      }, 4000);
    }

    function computeQrBox(){
      var maxSize = Math.min(window.innerWidth - 80, 420);
      var size = Math.max(220, Math.min(maxSize, window.innerHeight * 0.45));
      return { width: size, height: size };
    }

    function startScanner(cameraId){
      if(isStartingScanner){ return Promise.resolve(); }
      if(typeof Html5Qrcode === 'undefined'){
        showStatus('Scanner library missing.', 'error', true);
        return Promise.resolve();
      }
      isStartingScanner = true;
      var cameraConfig = cameraId ? { deviceId: { exact: cameraId } } : { facingMode: 'environment' };
      var config = { fps: 12, qrbox: computeQrBox() };
      var cleanupPromise = Promise.resolve();
      if(html5QrCode){
        cleanupPromise = html5QrCode.stop().catch(function(){}).then(function(){
          return html5QrCode.clear().catch(function(){});
        });
      }
      return cleanupPromise.then(function(){
        html5QrCode = new Html5Qrcode('reader');
        return html5QrCode.start(cameraConfig, config, onScanSuccess, function(){});
      }).catch(function(err){
        console.error(err);
        showStatus('Camera access error.', 'error', true);
      }).then(function(){
        isStartingScanner = false;
      });
    }

    function onScanSuccess(decodedText){
      if(!decodedText){ return; }
      try{ if(html5QrCode){ html5QrCode.pause(); } } catch(e){}
      handleScan(decodedText);
      setTimeout(function(){
        if(html5QrCode){
          html5QrCode.resume().catch(function(){});
        }
      }, 2200);
    }

    function setupScanner(){
      if(typeof Html5Qrcode === 'undefined'){
        showStatus('Scanner library missing.', 'error', true);
        return;
      }
      showStatus('Requesting camera access…', 'success', true);
      Html5QrCodePromise().then(function(){
        flipCameraBtn.hidden = !availableCameras || availableCameras.length < 2;
        var cameraId = availableCameras.length ? availableCameras[activeCameraIndex].id : undefined;
        return startScanner(cameraId);
      }).then(function(){
        if(availableCameras.length){
          var label = availableCameras[activeCameraIndex].label || 'camera';
          showStatus('Camera ready (' + label + '). Point to a member QR.', 'success');
        } else {
          showStatus('Camera ready. Point to a member QR.', 'success');
        }
      });
    }

    function Html5QrCodePromise(){
      return Html5Qrcode.getCameras().then(function(cameras){
        availableCameras = Array.isArray(cameras) ? cameras : [];
      }).catch(function(err){
        console.error(err);
        availableCameras = [];
      });
    }

    function handleScan(idCode){
      if(!idCode){ return; }
      showStatus('Processing ' + idCode + '...', 'success');
      if(typeof google === 'undefined' || !google.script){
        setTimeout(function(){ showStatus('(Local test) Marked ' + idCode + ' as Present', 'success'); }, 1000);
        return;
      }
      google.script.run.withSuccessHandler(function(res){
        if(res && res.success){
          showStatus('✅ ' + idCode + ' marked as Present', 'success');
        } else {
          showStatus(res && res.message ? res.message : 'Failed to record.', 'error');
        }
      }).withFailureHandler(function(err){
        console.error(err);
        showStatus('Connection error.', 'error');
      }).recordAttendanceScan(idCode);
    }

    function toggleModal(open){
      if(!modal) return;
      modal.style.display = open ? 'flex' : 'none';
      modal.setAttribute('aria-hidden', open ? 'false' : 'true');
      if(open){
        try{
          manualIdInput.focus({ preventScroll: true });
        } catch(e){
          manualIdInput.focus();
        }
      } else {
        manualIdInput.value = '';
        manualStatusSelect.value = 'Present';
      }
    }

    manualEntryBtn.addEventListener('click', function(){ toggleModal(true); });
    cancelManualBtn.addEventListener('click', function(){ toggleModal(false); });
    modal.addEventListener('click', function(event){
      if(event.target === modal){
        toggleModal(false);
      }
    });
    document.addEventListener('keydown', function(event){
      if(event.key === 'Escape' && modal.style.display === 'flex'){
        toggleModal(false);
      }
    });

    saveManualBtn.addEventListener('click', function(){
      var id = manualIdInput.value.trim();
      var status = manualStatusSelect.value;
      if(!id){
        showStatus('Please enter an ID code.', 'error');
        return;
      }
      toggleModal(false);
      showStatus('Recording ' + id + ' as ' + status + '...');
      if(typeof google === 'undefined' || !google.script){
        setTimeout(function(){ showStatus('(Local test) Recorded ' + id + ' as ' + status, 'success'); }, 1000);
        return;
      }
      google.script.run.withSuccessHandler(function(res){
        if(res && res.success){
          showStatus('✅ ' + id + ' marked as ' + status, 'success');
        } else {
          showStatus(res && res.message ? res.message : 'Failed to record.', 'error');
        }
      }).withFailureHandler(function(err){
        console.error(err);
        showStatus('Connection error.', 'error');
      }).recordManualAttendance(id, status);
    });

    flipCameraBtn.addEventListener('click', function(){
      if(!availableCameras.length){
        showStatus('No additional cameras detected.', 'error');
        return;
      }
      activeCameraIndex = (activeCameraIndex + 1) % availableCameras.length;
      var cameraId = availableCameras[activeCameraIndex].id;
      startScanner(cameraId).then(function(){
        var label = availableCameras[activeCameraIndex].label || 'camera';
        showStatus('Switched to ' + label + '.', 'success');
      });
    });

    backBtn.addEventListener('click', function(){
      if(typeof google !== 'undefined' && google.script && google.script.host){
        google.script.host.close();
      } else {
        window.close();
      }
    });

    window.addEventListener('resize', function(){
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(function(){
        var cameraId = availableCameras.length ? availableCameras[activeCameraIndex].id : undefined;
        startScanner(cameraId);
      }, 320);
    });

    window.addEventListener('load', function(){ setupScanner(); });
  });
})();
</script>
</body>
</html>
