<script>
(function (factory) {
  var root = typeof window !== 'undefined' ? window : typeof globalThis !== 'undefined' ? globalThis : {};
  factory(root);
})(function (root) {
  'use strict';

  if (!root || !root.document) {
    if (root) {
      root.loadAnnouncements = root.loadAnnouncements || function () {};
      root.renderAnnouncements = root.renderAnnouncements || function () {};
    }
    return;
  }

  var doc = root.document;
  var globalYsp = (root.YSP = root.YSP || {});
  var utils = (globalYsp.utils = globalYsp.utils || {});
  var callServer = typeof utils.callServer === 'function' ? utils.callServer : function () {};
  var toastFn = typeof root.toast === 'function' ? root.toast : function () {};
  var showModalFn = typeof root.showModal === 'function' ? root.showModal : function () { return doc.createElement('div'); };
  var closeModalFn = typeof root.closeModal === 'function' ? root.closeModal : function () {};
  var selectOne = typeof root.$ === 'function' ? root.$ : function () { return null; };
  var escapeHtml = typeof root.esc === 'function' ? root.esc : function (value) {
    return String(value == null ? '' : value);
  };

  var createBound = false;

  function loadAnnouncements() {
    if (!createBound) {
      var btn = selectOne('#btn-new-announcement');
      if (btn) {
        createBound = true;
        btn.addEventListener('click', openAnnouncementModal);
      }
    }
    callServer(
      'listAnnouncements',
      [],
      function (res) {
        var list = (res && res.data) || res || [];
        renderAnnouncements(list);
      },
      function (err) {
        if (root.console && typeof root.console.error === 'function') {
          root.console.error(err);
        }
        toastFn('Unable to load announcements.');
      },
      [
        { id: 'ANN-1', title: 'General Assembly', body: 'Join us this Saturday for our monthly assembly.', read: false },
        { id: 'ANN-2', title: 'Volunteer Drive', body: 'Sign up for the coastal cleanup happening next week.', read: true },
      ]
    );
  }

  function renderAnnouncements(list) {
    var container = selectOne('#announcement-list');
    if (!container) {
      return;
    }
    container.innerHTML = '';
    if (!list || !list.length) {
      container.innerHTML = '<p class="muted">No announcements yet.</p>';
      return;
    }
    list.forEach(function (item) {
      var card = doc.createElement('article');
      card.className = 'card announcement-card';
      card.style.borderLeft = item.read ? '4px solid rgba(0,0,0,0.08)' : '4px solid var(--primary)';
      card.innerHTML =
        '<h3>' +
        escapeHtml(item.title || 'Announcement') +
        '</h3><p class="muted">' +
        escapeHtml(item.body || '') +
        '</p>';
      container.appendChild(card);
    });
  }

  function openAnnouncementModal() {
    var panel = showModalFn({
      title: 'Create Announcement',
      bodyHtml:
        '<div class="form-group"><label>Title<input id="announcement-title" type="text" placeholder="Announcement title" /></label></div>' +
        '<div class="form-group"><label>Message<textarea id="announcement-body" rows="4" placeholder="Announcement body"></textarea></label></div>',
      footerHtml:
        '<button type="button" class="btn btn-outline" data-close="1">Cancel</button>' +
        '<button type="button" class="btn btn-primary" id="announcement-save">Publish</button>',
    });
    if (!panel || typeof panel.querySelector !== 'function') {
      return;
    }
    var save = panel.querySelector('#announcement-save');
    if (save) {
      save.addEventListener('click', function () {
        var titleEl = selectOne('#announcement-title');
        var bodyEl = selectOne('#announcement-body');
        var title = String((titleEl && titleEl.value) || '').trim();
        var body = String((bodyEl && bodyEl.value) || '').trim();
        if (!title || !body) {
          toastFn('Please provide a title and message.');
          return;
        }
        callServer(
          'createAnnouncement',
          [{ title: title, body: body }],
          function (res) {
            closeModalFn();
            toastFn(res && res.message ? res.message : 'Announcement posted.');
            loadAnnouncements();
          },
          function (err) {
            if (root.console && typeof root.console.error === 'function') {
              root.console.error(err);
            }
            toastFn('Unable to publish announcement.');
          },
          { success: true, message: 'Announcement created.' }
        );
      });
    }
  }

  globalYsp.announcements = globalYsp.announcements || {};
  globalYsp.announcements.loadAnnouncements = loadAnnouncements;
  globalYsp.announcements.renderAnnouncements = renderAnnouncements;

  root.loadAnnouncements = loadAnnouncements;
  root.renderAnnouncements = renderAnnouncements;
});
</script>
